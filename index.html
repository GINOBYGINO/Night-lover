<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æš—å¤œé…’é¤¨ - æƒ…æ›¸å¡ç‰ŒéŠæˆ²</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root {
            --dark-brown: #2c1b0f;
            --medium-brown: #4a3728;
            --light-brown: #7a5c3c;
            --gold: #d4af37;
            --light-gold: #f4e4b5;
            --dark-gold: #b8941f;
            --red: #8b0000;
            --green: #006400;
            --text-light: #f5deb3;
            --text-dark: #3d2c1e;
            --card-bg: #f8f1e5;
            --shadow: rgba(0, 0, 0, 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(to bottom, var(--dark-brown), var(--medium-brown));
            color: var(--text-light);
            min-height: 100vh;
            padding: 10px;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* æ¨™é¡Œå€åŸŸ */
        header {
            text-align: center;
            padding: 15px;
            border-bottom: 2px solid var(--gold);
            margin-bottom: 20px;
            background-color: rgba(44, 27, 15, 0.8);
            border-radius: 10px;
            box-shadow: 0 5px 15px var(--shadow);
        }

        h1 {
            color: var(--gold);
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px var(--shadow);
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.2rem;
            color: var(--light-gold);
            margin-bottom: 15px;
        }

        /* ä¸»éŠæˆ²å€åŸŸ */
        .game-area {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* æˆ¿é–“å€åŸŸ */
        .room-section {
            background-color: rgba(74, 55, 40, 0.9);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px var(--shadow);
            border: 1px solid var(--light-brown);
        }

        .room-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            min-width: 200px;
        }

        label {
            margin-bottom: 5px;
            color: var(--light-gold);
            font-weight: bold;
        }

        input, select, button {
            padding: 12px 15px;
            border-radius: 5px;
            border: 1px solid var(--light-brown);
            font-size: 1rem;
        }

        input, select {
            background-color: var(--card-bg);
            color: var(--text-dark);
        }

        button {
            background-color: var(--gold);
            color: var(--dark-brown);
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        button:hover:not(:disabled) {
            background-color: var(--light-gold);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .danger-btn {
            background-color: var(--red);
            color: white;
        }

        .success-btn {
            background-color: var(--green);
            color: white;
        }

        /* ç©å®¶åˆ—è¡¨ */
        .players-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .player-card {
            background-color: rgba(122, 92, 60, 0.7);
            border-radius: 8px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .player-card.host {
            border-color: var(--gold);
            background-color: rgba(122, 92, 60, 0.9);
        }

        .player-card.current-turn {
            border-color: var(--green);
            box-shadow: 0 0 10px var(--green);
        }

        .player-card.eliminated {
            opacity: 0.7;
            border-color: var(--red);
        }

        .player-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            background-color: var(--dark-brown);
        }

        .player-info {
            flex-grow: 1;
        }

        .player-name {
            font-weight: bold;
            font-size: 1.2rem;
        }

        .player-status {
            font-size: 0.9rem;
            color: var(--light-gold);
        }

        /* éŠæˆ²å€åŸŸ */
        .game-section {
            display: none;
            background-color: rgba(74, 55, 40, 0.9);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px var(--shadow);
            border: 1px solid var(--light-brown);
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--light-brown);
        }

        .game-info {
            display: flex;
            gap: 20px;
            font-size: 1.1rem;
        }

        .deck-info, .turn-info {
            background-color: rgba(44, 27, 15, 0.7);
            padding: 10px 15px;
            border-radius: 5px;
        }

        /* æ‰‹ç‰Œå€åŸŸ */
        .hand-container {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .card {
            width: 180px;
            height: 250px;
            background-color: var(--card-bg);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            color: var(--text-dark);
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 8px 16px var(--shadow);
            border: 3px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 25px var(--shadow);
        }

        .card.selected {
            border-color: var(--gold);
            box-shadow: 0 0 20px var(--gold);
        }

        .card.played {
            opacity: 0.5;
            cursor: default;
        }

        .card.played:hover {
            transform: none;
        }

        .card-number {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: var(--gold);
            color: var(--dark-brown);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .card-gender {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5rem;
        }

        .male {
            color: #1e90ff;
        }

        .female {
            color: #ff69b4;
        }

        .card-name {
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            margin-top: 20px;
            color: var(--dark-brown);
        }

        .card-effect {
            font-size: 0.9rem;
            text-align: center;
            margin-top: 10px;
            flex-grow: 1;
            display: flex;
            align-items: center;
            padding: 0 5px;
        }

        .card-back {
            background: linear-gradient(135deg, var(--dark-brown) 0%, var(--light-brown) 100%);
            color: var(--light-gold);
            justify-content: center;
            font-size: 3rem;
        }

        .card-back .card-name {
            color: var(--light-gold);
        }

        /* éŠæˆ²æ§åˆ¶å€ */
        .game-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .action-btn {
            min-width: 180px;
            padding: 15px;
            font-size: 1.1rem;
        }

        /* é€²åº¦æ¢ */
        .progress-container {
            width: 100%;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            margin: 20px 0;
            overflow: hidden;
            display: none;
        }

        .progress-bar {
            height: 20px;
            background: linear-gradient(to right, var(--dark-gold), var(--gold));
            width: 0%;
            transition: width 0.5s;
            text-align: center;
            color: var(--dark-brown);
            font-weight: bold;
            line-height: 20px;
        }

        /* æ—¥èªŒå€åŸŸ */
        .log-section {
            background-color: rgba(44, 27, 15, 0.9);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px var(--shadow);
            border: 1px solid var(--light-brown);
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: var(--gold);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .log-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .log-entry {
            padding: 10px;
            border-radius: 5px;
            background-color: rgba(122, 92, 60, 0.5);
            border-left: 4px solid var(--gold);
        }

        .log-entry.system {
            border-left-color: var(--light-gold);
            font-style: italic;
        }

        .log-entry.player-action {
            border-left-color: var(--green);
        }

        .log-entry.elimination {
            border-left-color: var(--red);
        }

        /* æç¤ºå¡/å‰©é¤˜ç‰Œè¡¨ */
        .hint-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .hint-content {
            background-color: var(--medium-brown);
            border-radius: 10px;
            padding: 30px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            border: 3px solid var(--gold);
            position: relative;
        }

        .close-hint {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: var(--light-gold);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .hint-title {
            color: var(--gold);
            font-size: 2rem;
            margin-bottom: 20px;
            text-align: center;
        }

        .cards-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .cards-table th, .cards-table td {
            border: 1px solid var(--light-brown);
            padding: 12px;
            text-align: center;
        }

        .cards-table th {
            background-color: var(--dark-brown);
            color: var(--gold);
        }

        .cards-table td {
            background-color: rgba(248, 241, 229, 0.1);
        }

        .cards-table tr:hover td {
            background-color: rgba(248, 241, 229, 0.2);
        }

        /* å¾…æ©Ÿæˆ¿å°éŠæˆ² */
        .waiting-room {
            background-color: rgba(44, 27, 15, 0.9);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
            border: 1px solid var(--light-brown);
        }

        .waiting-title {
            color: var(--gold);
            font-size: 1.5rem;
            margin-bottom: 15px;
        }

        .mini-game {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .dice-game {
            background-color: rgba(122, 92, 60, 0.7);
            padding: 20px;
            border-radius: 10px;
            width: 100%;
            max-width: 400px;
        }

        .dice-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }

        .dice {
            width: 60px;
            height: 60px;
            background-color: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: var(--dark-brown);
            box-shadow: 0 5px 10px var(--shadow);
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .room-controls {
                flex-direction: column;
            }
            
            .input-group {
                width: 100%;
            }
            
            .hand-container {
                flex-direction: column;
                align-items: center;
            }
            
            .game-controls {
                flex-direction: column;
                align-items: center;
            }
            
            .game-header {
                flex-direction: column;
                gap: 15px;
            }
        }

        /* å‹•ç•« */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 1.5s infinite;
        }

        /* å·¥å…·é¡ */
        .hidden {
            display: none !important;
        }

        .visible {
            display: block !important;
        }

        .text-center {
            text-align: center;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .mb-20 {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-crown"></i> æš—å¤œé…’é¤¨ - æƒ…æ›¸å¡ç‰ŒéŠæˆ²</h1>
            <div class="subtitle">èˆ‡2-5ä½æœ‹å‹åŒæ¨‚çš„å¡ç‰ŒéŠæˆ²ï¼Œå°å¿ƒåˆºå®¢ï¼Œå®ˆè­·å…¬ä¸»ï¼</div>
        </header>
        
        <div class="game-area">
            <!-- æˆ¿é–“å€åŸŸ -->
            <section class="room-section" id="roomSection">
                <h2>éŠæˆ²æˆ¿é–“</h2>
                <div class="room-controls">
                    <div class="input-group">
                        <label for="playerName">ä½ çš„åå­—</label>
                        <input type="text" id="playerName" placeholder="è¼¸å…¥ä½ çš„åå­—" value="ç©å®¶">
                    </div>
                    
                    <div class="input-group">
                        <label for="roomId">æˆ¿é–“ID</label>
                        <input type="text" id="roomId" placeholder="è¼¸å…¥æˆ¿é–“ID (ç•™ç©ºå‰‡å‰µå»ºæ–°æˆ¿é–“)">
                    </div>
                    
                    <div class="input-group">
                        <label for="avatar">é¸æ“‡é ­åƒ</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <div id="avatarDisplay" style="font-size: 2rem; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; background-color: var(--dark-brown); border-radius: 50%;">ğŸ˜Š</div>
                            <button id="randomAvatar" style="flex-grow: 1;">éš¨æ©Ÿé ­åƒ</button>
                        </div>
                    </div>
                    
                    <button id="joinRoom" class="success-btn">
                        <i class="fas fa-door-open"></i> åŠ å…¥æˆ¿é–“
                    </button>
                    
                    <button id="startGame" class="success-btn" disabled>
                        <i class="fas fa-play"></i> é–‹å§‹éŠæˆ²
                    </button>
                    
                    <button id="leaveRoom" class="danger-btn" disabled>
                        <i class="fas fa-door-closed"></i> é›¢é–‹æˆ¿é–“
                    </button>
                </div>
                
                <div class="players-container" id="playersContainer">
                    <!-- ç©å®¶åˆ—è¡¨å°‡å‹•æ…‹ç”Ÿæˆ -->
                    <div class="text-center" style="grid-column: 1 / -1; padding: 20px; color: var(--light-gold);">
                        ç­‰å¾…ç©å®¶åŠ å…¥æˆ¿é–“...
                    </div>
                </div>
                
                <!-- å¾…æ©Ÿæˆ¿å°éŠæˆ² -->
                <div class="waiting-room">
                    <div class="waiting-title">ç­‰å¾…éŠæˆ²é–‹å§‹...</div>
                    <div class="mini-game">
                        <p>æ“²éª°å­æ‰“ç™¼æ™‚é–“ï¼Œæ¯”èª°é»æ•¸å¤§ï¼</p>
                        <div class="dice-game">
                            <div class="dice-container">
                                <div class="dice" id="dice1">?</div>
                                <div class="dice" id="dice2">?</div>
                            </div>
                            <button id="rollDice">
                                <i class="fas fa-dice"></i> æ“²éª°å­
                            </button>
                            <div id="diceResult" class="mt-20"></div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- éŠæˆ²å€åŸŸ -->
            <section class="game-section" id="gameSection">
                <div class="game-header">
                    <div>
                        <h2>éŠæˆ²é€²è¡Œä¸­</h2>
                        <div class="game-info">
                            <div class="deck-info">
                                <i class="fas fa-layer-group"></i> ç‰Œåº«å‰©é¤˜: <span id="deckCount">0</span> å¼µ
                            </div>
                            <div class="turn-info">
                                <i class="fas fa-user-clock"></i> ç•¶å‰å›åˆ: <span id="currentPlayer">-</span>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <button id="showHint">
                            <i class="fas fa-question-circle"></i> æç¤ºå¡/å‰©é¤˜ç‰Œè¡¨
                        </button>
                        <button id="endTurn" disabled>
                            <i class="fas fa-forward"></i> çµæŸå›åˆ
                        </button>
                    </div>
                </div>
                
                <!-- é€²åº¦æ¢ -->
                <div class="progress-container" id="progressContainer">
                    <div class="progress-bar" id="progressBar">è™•ç†ä¸­...</div>
                </div>
                
                <!-- æ‰‹ç‰Œå€åŸŸ -->
                <div class="hand-container" id="handContainer">
                    <!-- æ‰‹ç‰Œå°‡å‹•æ…‹ç”Ÿæˆ -->
                    <div class="card card-back">
                        <div class="card-name">ç‰ŒèƒŒ</div>
                        <i class="fas fa-question"></i>
                    </div>
                    <div class="card card-back">
                        <div class="card-name">ç‰ŒèƒŒ</div>
                        <i class="fas fa-question"></i>
                    </div>
                </div>
                
                <!-- éŠæˆ²æ§åˆ¶å€ -->
                <div class="game-controls">
                    <button id="drawCard" class="action-btn" disabled>
                        <i class="fas fa-hand-paper"></i> æŠ½ä¸€å¼µç‰Œ
                    </button>
                    <button id="playCard" class="action-btn" disabled>
                        <i class="fas fa-play-circle"></i> æ‰“å‡ºé¸ä¸­çš„ç‰Œ
                    </button>
                    <button id="viewDiscard" class="action-btn">
                        <i class="fas fa-trash-alt"></i> æŸ¥çœ‹æ£„ç‰Œå †
                    </button>
                </div>
                
                <!-- ç©å®¶é¸æ“‡å€åŸŸï¼ˆç”¨æ–¼éœ€è¦æŒ‡å®šç›®æ¨™çš„å¡ç‰Œï¼‰ -->
                <div id="playerSelection" class="hidden" style="margin-top: 20px; padding: 20px; background-color: rgba(44, 27, 15, 0.7); border-radius: 10px;">
                    <h3>é¸æ“‡ç›®æ¨™ç©å®¶</h3>
                    <div id="selectablePlayers" style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 15px;">
                        <!-- å¯é¸ç©å®¶å°‡å‹•æ…‹ç”Ÿæˆ -->
                    </div>
                    <button id="cancelSelection" style="margin-top: 15px;">å–æ¶ˆé¸æ“‡</button>
                </div>
                
                <!-- çŒœç‰Œé¸æ“‡å€åŸŸï¼ˆç”¨æ–¼è¡›å…µ/å…µé•·ï¼‰ -->
                <div id="guessSelection" class="hidden" style="margin-top: 20px; padding: 20px; background-color: rgba(44, 27, 15, 0.7); border-radius: 10px;">
                    <h3>çŒœæ¸¬ç›®æ¨™ç©å®¶çš„æ‰‹ç‰Œ</h3>
                    <div style="margin-bottom: 15px;">
                        <p>ä½ æ­£åœ¨çŒœæ¸¬ <span id="guessTargetName" style="font-weight: bold; color: var(--gold);">-</span> çš„æ‰‹ç‰Œ</p>
                    </div>
                    <div id="guessOptions" style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 15px;">
                        <!-- çŒœç‰Œé¸é …å°‡å‹•æ…‹ç”Ÿæˆ -->
                    </div>
                    <button id="cancelGuess" style="margin-top: 15px;">å–æ¶ˆçŒœç‰Œ</button>
                </div>
            </section>
            
            <!-- éŠæˆ²æ—¥èªŒå€åŸŸ -->
            <section class="log-section">
                <div class="log-title">
                    <span>éŠæˆ²æ—¥èªŒ</span>
                    <button id="clearLog" style="background: none; border: none; color: var(--light-gold); font-size: 1rem;">
                        <i class="fas fa-trash-alt"></i> æ¸…ç©ºæ—¥èªŒ
                    </button>
                </div>
                <div class="log-content" id="gameLog">
                    <div class="log-entry system">
                        <i class="fas fa-info-circle"></i> æ­¡è¿ä¾†åˆ°æš—å¤œé…’é¤¨å¡ç‰ŒéŠæˆ²ï¼è«‹åŠ å…¥æˆ–å‰µå»ºä¸€å€‹æˆ¿é–“é–‹å§‹éŠæˆ²ã€‚
                    </div>
                </div>
            </section>
        </div>
    </div>
    
    <!-- æç¤ºå¡/å‰©é¤˜ç‰Œè¡¨æ¨¡æ…‹æ¡† -->
    <div class="hint-modal" id="hintModal">
        <div class="hint-content">
            <button class="close-hint" id="closeHint">&times;</button>
            <h2 class="hint-title">æç¤ºå¡ / å‰©é¤˜ç‰Œè¡¨</h2>
            <table class="cards-table">
                <thead>
                    <tr>
                        <th>è™Ÿç¢¼</th>
                        <th>è§’è‰²åç¨±</th>
                        <th>æ€§åˆ¥</th>
                        <th>ç¸½å¼µæ•¸</th>
                        <th>å‰©é¤˜å¼µæ•¸</th>
                        <th>æŠ€èƒ½èªªæ˜</th>
                    </tr>
                </thead>
                <tbody id="cardsTableBody">
                    <!-- å¡ç‰‡è³‡è¨Šå°‡å‹•æ…‹ç”Ÿæˆ -->
                </tbody>
            </table>
        </div>
    </div>
    
    <script>
        // éŠæˆ²å¸¸é‡
        const CARDS = {
            1: { name: "åˆºå®¢", gender: "male", count: 3, effect: "æŒæœ‰é€™å¼µç‰Œæ™‚ï¼Œè‹¥æœ‰äººçŒœéŒ¯ä½ çš„èº«åˆ†ï¼Œå°æ–¹å‡ºå±€ï¼Œä½ æ£„æ‰æ­¤æ‰‹ç‰Œï¼Œå†æŠ½ä¸€å¼µ" },
            2: { name: "è¡›å…µ", gender: "female", count: 5, effect: "çŒœä»»ä¸€å€‹ç©å®¶çš„æ‰‹ç‰Œï¼ŒçŒœå°è©²ç©å®¶å‡ºå±€ï¼ŒçŒœéŒ¯æ²’äº‹ã€‚ä¸å¯ä»¥çŒœ2è™Ÿã€‚" },
            2.5: { name: "å…µé•·", gender: "female", count: 1, effect: "çŒœæ¯ä¸€å€‹ç©å®¶çš„æ‰‹ç‰Œï¼ŒçŒœå°è©²ç©å®¶å‡ºå±€ï¼ŒçŒœéŒ¯æ²’äº‹ã€‚ä¸å¯ä»¥çŒœ2è™Ÿã€‚" },
            3: { name: "ç¥çˆ¶", gender: "male", count: 2, effect: "ç§åº•ä¸‹æŸ¥çœ‹ä»»ä¸€ä½ç©å®¶çš„æ‰‹ç‰Œï¼Œä¸å¯ä»¥å…¬é–‹çµ¦å…¶ä»–ç©å®¶ã€‚" },
            3.5: { name: "é‚±æ¯”ç‰¹", gender: "male", count: 2, effect: "ç§åº•ä¸‹èˆ‡ä»»ä¸€ä½ç©å®¶ç”¨æ‰‹ç‰Œæ¯”å¤§å°ï¼ŒåŒæ€§æ™‚ï¼Œæ•¸å­—å°çš„ç©å®¶å‡ºå±€ï¼Œç•°æ€§æ™‚ï¼Œæ•¸å­—å¤§çš„ç©å®¶å‡ºå±€ï¼Œå¹³æ‰‹æ²’äº‹ã€‚" },
            4: { name: "ç”·çˆµ", gender: "male", count: 2, effect: "ç§åº•ä¸‹èˆ‡ä»»ä¸€ä½ç©å®¶ç”¨æ‰‹ç‰Œæ¯”å¤§å°ï¼Œæ•¸å­—å°çš„ç©å®¶å‡ºå±€ï¼Œå¹³æ‰‹æ²’äº‹ã€‚" },
            4.5: { name: "é è¨€å®¶", gender: "female", count: 2, effect: "æŠ½ä¸€å¼µç‰Œï¼Œå°‡æ­¤ç‰Œæˆ–æ‰‹ç‰Œå…¶ä¸€æ”¾å…¥ç‰Œåº«æœ€ä¸‹æ–¹" },
            5: { name: "ä¾å¥³", gender: "female", count: 2, effect: "æ‰“å‡ºæ­¤å¡çš„ç©å®¶ï¼Œåœ¨ä¸‹æ¬¡è¼ªåˆ°ä»–ä¹‹å‰ï¼Œéƒ½æ˜¯ç„¡æ•µçš„ç‹€æ…‹ï¼Œå…¶ä»–ç©å®¶ä¸å¯ä»¥å°ä»–ä½¿ç”¨æŠ€èƒ½ã€‚" },
            5.5: { name: "å°ä¸‘", gender: "male", count: 2, effect: "ä½¿ç”¨å…¶é¤˜ç©å®¶æœ€å¾Œæ‰“å‡ºçš„ç‰Œï¼Œè‹¥å ´ä¸Šç„¡ç‰Œï¼Œå‰‡æ²’æœ‰æ•ˆæœ" },
            6: { name: "ç‹å­", gender: "male", count: 1, effect: "æŒ‡å®šä»»ä¸€ä½ç©å®¶é¢æœä¸Šæ£„æ‰æ‰‹ç‰Œï¼Œä¸¦å†æŠ½ä¸€å¼µæ–°ç‰Œã€‚å¯ä»¥æŒ‡å®šè‡ªå·±ã€‚" },
            7: { name: "åœ‹ç‹", gender: "male", count: 1, effect: "èˆ‡ä»»ä¸€ä½ç©å®¶äº¤æ›æ‰‹ç‰Œã€‚" },
            8: { name: "ä¼¯çˆµå¤«äºº", gender: "female", count: 1, effect: "ç•¶ç©å®¶æ‰‹ä¸­æœ‰ç‹å­æˆ–åœ‹ç‹èˆ‡å…¬çˆµå¤«äººï¼Œå¿…é ˆæ‰“å‡ºå…¬çˆµå¤«äººï¼Œä¸å¯ä»¥æ‰“å‡ºç‹å­æˆ–åœ‹ç‹ã€‚" },
            9: { name: "å…¬ä¸»", gender: "female", count: 1, effect: "ç©å®¶è‹¥æ£„æ‰è©²ç‰Œï¼Œç›´æ¥å‡ºå±€ã€‚åœ¨æ¯”å¤§å°æ™‚å¿…å‹(åŒ…å«é‚±æ¯”ç‰¹)" }
        };
        
        const EMOJIS = ["ğŸ˜€", "ğŸ˜", "ğŸ¤ ", "ğŸ§", "ğŸ¤©", "ğŸ¥³", "ğŸ˜‡", "ğŸ˜ˆ", "ğŸ‘»", "ğŸ¤–", "ğŸ‘½", "ğŸ¶", "ğŸ±", "ğŸ¼", "ğŸ¦Š", "ğŸ¯", "ğŸ¦", "ğŸ®", "ğŸ·", "ğŸµ", "ğŸ”", "ğŸ§", "ğŸ¦", "ğŸº", "ğŸ¦„"];
        
        // éŠæˆ²ç‹€æ…‹è®Šæ•¸
        let peer = null;
        let conn = null;
        let hostConnections = [];
        let isHost = false;
        let playerId = null;
        let playerName = "";
        let playerAvatar = "ğŸ˜Š";
        let roomId = "";
        let gameState = {
            players: [],
            deck: [],
            discardPile: [],
            currentPlayerIndex: -1,
            phase: "waiting", // waiting, setup, playing, ended
            selectedCard: null,
            lastPlayedCard: null,
            protectedPlayers: [], // å—ä¾å¥³ä¿è­·çš„ç©å®¶
            eliminatedPlayers: [],
            removedCard: null
        };
        
        // DOM å…ƒç´ 
        const roomSection = document.getElementById("roomSection");
        const gameSection = document.getElementById("gameSection");
        const playersContainer = document.getElementById("playersContainer");
        const handContainer = document.getElementById("handContainer");
        const gameLog = document.getElementById("gameLog");
        const deckCount = document.getElementById("deckCount");
        const currentPlayer = document.getElementById("currentPlayer");
        const progressContainer = document.getElementById("progressContainer");
        const progressBar = document.getElementById("progressBar");
        const cardsTableBody = document.getElementById("cardsTableBody");
        
        // åˆå§‹åŒ–
        document.addEventListener("DOMContentLoaded", function() {
            // ç”Ÿæˆéš¨æ©Ÿæˆ¿é–“ID
            document.getElementById("roomId").placeholder = "ç•™ç©ºä»¥å‰µå»ºæˆ¿é–“ (ä¾‹å¦‚: " + generateRoomId() + ")";
            
            // äº‹ä»¶ç›£è½å™¨
            document.getElementById("randomAvatar").addEventListener("click", randomizeAvatar);
            document.getElementById("joinRoom").addEventListener("click", joinOrCreateRoom);
            document.getElementById("startGame").addEventListener("click", startGame);
            document.getElementById("leaveRoom").addEventListener("click", leaveRoom);
            document.getElementById("showHint").addEventListener("click", showHint);
            document.getElementById("closeHint").addEventListener("click", hideHint);
            document.getElementById("drawCard").addEventListener("click", drawCard);
            document.getElementById("playCard").addEventListener("click", playCard);
            document.getElementById("endTurn").addEventListener("click", endTurn);
            document.getElementById("viewDiscard").addEventListener("click", viewDiscard);
            document.getElementById("clearLog").addEventListener("click", clearLog);
            document.getElementById("rollDice").addEventListener("click", rollDice);
            
            // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
            document.getElementById("hintModal").addEventListener("click", function(e) {
                if (e.target === this) hideHint();
            });
            
            // åˆå§‹åŒ–ç©å®¶åç¨±
            playerName = document.getElementById("playerName").value;
            document.getElementById("playerName").addEventListener("change", function() {
                playerName = this.value;
                if (conn && isHost) {
                    broadcast({ type: "PLAYER_UPDATE", playerId, name: playerName, avatar: playerAvatar });
                }
            });
        });
        
        // ç”Ÿæˆéš¨æ©Ÿæˆ¿é–“ID
        function generateRoomId() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }
        
        // éš¨æ©Ÿé ­åƒ
        function randomizeAvatar() {
            const randomEmoji = EMOJIS[Math.floor(Math.random() * EMOJIS.length)];
            playerAvatar = randomEmoji;
            document.getElementById("avatarDisplay").textContent = randomEmoji;
            
            if (conn && isHost) {
                broadcast({ type: "PLAYER_UPDATE", playerId, name: playerName, avatar: playerAvatar });
            }
        }
        
        // åŠ å…¥æˆ–å‰µå»ºæˆ¿é–“
        function joinOrCreateRoom() {
            playerName = document.getElementById("playerName").value.trim() || "ç©å®¶";
            roomId = document.getElementById("roomId").value.trim();
            
            if (!roomId) {
                // å‰µå»ºæ–°æˆ¿é–“
                roomId = generateRoomId();
                document.getElementById("roomId").value = roomId;
                isHost = true;
                logMessage(`å·²å‰µå»ºæˆ¿é–“: ${roomId}`, "system");
            } else {
                logMessage(`æ­£åœ¨åŠ å…¥æˆ¿é–“: ${roomId}`, "system");
            }
            
            // åˆå§‹åŒ–PeerJS
            playerId = playerName + "_" + Math.random().toString(36).substring(2, 9);
            // æ›¿æ›æ‚¨ç¾æœ‰çš„ peer = new Peer(...) éƒ¨åˆ†
peer = new Peer(playerId, {
    host: '0.peerjs.com', // PeerJS çš„å…¬å…±ä¿¡ä»¤ä¼ºæœå™¨
    port: 443,
    path: '/',
    secure: true,
    config: {
        'iceServers': [
            { urls: 'stun:stun.l.google.com:19302' }, // å…è²»çš„å…¬å…± STUN ä¼ºæœå™¨
            { urls: 'stun:global.stun.twilio.com:3478' }
            // å¦‚æœéœ€è¦æ›´å¼·çš„é€£ç·šèƒ½åŠ›ï¼Œå¯è€ƒæ…®åŠ å…¥ä»˜è²»çš„ TURN ä¼ºæœå™¨
            // { urls: 'turn:your.turn.server:3478', username: 'username', credential: 'password' }
        ]
    },
    debug: 2 // å¯è¨­å®šç‚º 0 ä»¥æ¸›å°‘æ§åˆ¶å°æ—¥èªŒ
});
            
            peer.on('open', function(id) {
                logMessage(`é€£ç·šæˆåŠŸ! ä½ çš„ID: ${id}`, "system");
                
                if (isHost) {
                    logMessage(`ä½ æ˜¯æˆ¿ä¸»ï¼Œç­‰å¾…å…¶ä»–ç©å®¶åŠ å…¥...`, "system");
                    document.getElementById("startGame").disabled = false;
                } else {
                    // å˜—è©¦é€£æ¥åˆ°ä¸»æ©Ÿ
                    conn = peer.connect(roomId + "_host");
                    setupConnection(conn);
                }
                
                document.getElementById("joinRoom").disabled = true;
                document.getElementById("leaveRoom").disabled = false;
                document.getElementById("playerName").disabled = true;
                document.getElementById("roomId").disabled = true;
                
                // å°‡è‡ªå·±åŠ å…¥ç©å®¶åˆ—è¡¨
                if (isHost) {
                    gameState.players.push({
                        id: playerId,
                        name: playerName,
                        avatar: playerAvatar,
                        isHost: true,
                        hand: [],
                        isProtected: false,
                        isEliminated: false
                    });
                    updatePlayersDisplay();
                }
            });
            
            peer.on('connection', function(connection) {
                if (isHost) {
                    logMessage(`${connection.peer} æ­£åœ¨é€£ç·š...`, "system");
                    setupConnection(connection);
                }
            });
            
            peer.on('error', function(err) {
                logMessage(`é€£ç·šéŒ¯èª¤: ${err.type}`, "system");
                console.error('PeerJS error:', err);
            });
        }
        
        // è¨­ç½®é€£ç·š
        function setupConnection(connection) {
            conn = connection;
            
            connection.on('open', function() {
                logMessage(`å·²é€£ç·šåˆ° ${connection.peer}`, "system");
                
                if (isHost) {
                    hostConnections.push(connection);
                    
                    // ç™¼é€æ­¡è¿è¨Šæ¯å’Œç•¶å‰éŠæˆ²ç‹€æ…‹
                    connection.send({
                        type: "WELCOME",
                        playerId: connection.peer,
                        gameState: gameState,
                        isHost: false
                    });
                    
                    // å»£æ’­æ–°ç©å®¶åŠ å…¥
                    broadcast({
                        type: "PLAYER_JOINED",
                        player: {
                            id: connection.peer,
                            name: connection.peer.split("_")[0],
                            avatar: "ğŸ˜Š",
                            isHost: false,
                            hand: [],
                            isProtected: false,
                            isEliminated: false
                        }
                    });
                } else {
                    // ç™¼é€åŠ å…¥è¨Šæ¯
                    connection.send({
                        type: "JOIN",
                        playerId: playerId,
                        name: playerName,
                        avatar: playerAvatar
                    });
                }
            });
            
            connection.on('data', function(data) {
                handleMessage(data, connection);
            });
            
            connection.on('close', function() {
                logMessage(`é€£ç·šé—œé–‰: ${connection.peer}`, "system");
                if (isHost) {
                    // å¾é€£ç·šåˆ—è¡¨ä¸­ç§»é™¤
                    const index = hostConnections.indexOf(connection);
                    if (index > -1) hostConnections.splice(index, 1);
                    
                    // å¾ç©å®¶åˆ—è¡¨ä¸­ç§»é™¤
                    const playerIndex = gameState.players.findIndex(p => p.id === connection.peer);
                    if (playerIndex > -1) {
                        const playerName = gameState.players[playerIndex].name;
                        gameState.players.splice(playerIndex, 1);
                        logMessage(`${playerName} å·²é›¢é–‹æˆ¿é–“`, "system");
                        broadcast({ type: "PLAYER_LEFT", playerId: connection.peer });
                    }
                }
            });
            
            connection.on('error', function(err) {
                logMessage(`é€£ç·šéŒ¯èª¤: ${err}`, "system");
                console.error('Connection error:', err);
            });
        }
        
        // è™•ç†è¨Šæ¯
        function handleMessage(data, connection) {
            console.log("æ”¶åˆ°è¨Šæ¯:", data);
            
            switch(data.type) {
                case "JOIN":
                    if (isHost) {
                        // å°‡æ–°ç©å®¶åŠ å…¥éŠæˆ²
                        const newPlayer = {
                            id: data.playerId,
                            name: data.name,
                            avatar: data.avatar,
                            isHost: false,
                            hand: [],
                            isProtected: false,
                            isEliminated: false
                        };
                        
                        gameState.players.push(newPlayer);
                        logMessage(`${data.name} åŠ å…¥äº†éŠæˆ²`, "system");
                        
                        // é€šçŸ¥æ‰€æœ‰ç©å®¶
                        broadcast({
                            type: "PLAYER_JOINED",
                            player: newPlayer
                        });
                        
                        // å›å‚³ç¢ºèªè¨Šæ¯
                        connection.send({
                            type: "JOIN_ACCEPTED",
                            playerId: data.playerId,
                            gameState: gameState
                        });
                    }
                    break;
                    
                case "START_GAME":
                    if (!isHost) {
                        gameState = data.gameState;
                        startGameUI();
                        updateGameDisplay();
                        logMessage("éŠæˆ²é–‹å§‹!", "system");
                    }
                    break;
                    
                case "GAME_STATE_UPDATE":
                    if (!isHost) {
                        gameState = data.gameState;
                        updateGameDisplay();
                    }
                    break;
                    
                case "PLAYER_UPDATE":
                    if (!isHost) {
                        // æ›´æ–°ç©å®¶è³‡è¨Š
                        const playerIndex = gameState.players.findIndex(p => p.id === data.playerId);
                        if (playerIndex > -1) {
                            gameState.players[playerIndex].name = data.name;
                            gameState.players[playerIndex].avatar = data.avatar;
                            updatePlayersDisplay();
                        }
                    }
                    break;
                    
                case "PLAYER_JOINED":
                    if (!isHost) {
                        gameState.players.push(data.player);
                        updatePlayersDisplay();
                        logMessage(`${data.player.name} åŠ å…¥äº†éŠæˆ²`, "system");
                    }
                    break;
                    
                case "PLAYER_LEFT":
                    if (!isHost) {
                        const playerIndex = gameState.players.findIndex(p => p.id === data.playerId);
                        if (playerIndex > -1) {
                            const playerName = gameState.players[playerIndex].name;
                            gameState.players.splice(playerIndex, 1);
                            updatePlayersDisplay();
                            logMessage(`${playerName} å·²é›¢é–‹æˆ¿é–“`, "system");
                        }
                    }
                    break;
                    
                case "LOG_MESSAGE":
                    logMessage(data.message, data.messageType);
                    break;
                    
                case "ACTION_REQUEST":
                    if (isHost) {
                        handleActionRequest(data, connection);
                    }
                    break;
                    
                case "DICE_ROLL_RESULT":
                    if (isHost) {
                        broadcast(data);
                    } else {
                        document.getElementById("diceResult").innerHTML = `
                            <strong>${data.playerName}</strong> æ“²å‡ºäº† 
                            <span style="color:var(--gold);">${data.dice1}</span> å’Œ 
                            <span style="color:var(--gold);">${data.dice2}</span> 
                            (ç¸½å’Œ: ${data.total})
                        `;
                    }
                    break;
            }
        }
        
        // å»£æ’­è¨Šæ¯çµ¦æ‰€æœ‰ç©å®¶
        function broadcast(message) {
            if (isHost) {
                // ç™¼é€çµ¦æ‰€æœ‰é€£ç·šçš„ç©å®¶
                hostConnections.forEach(conn => {
                    conn.send(message);
                });
                
                // å¦‚æœæ˜¯éŠæˆ²ç‹€æ…‹æ›´æ–°ï¼Œä¹Ÿéœ€è¦æ›´æ–°æˆ¿ä¸»è‡ªå·±çš„é¡¯ç¤º
                if (message.type === "GAME_STATE_UPDATE") {
                    updateGameDisplay();
                }
                
                // å¦‚æœæ˜¯æ—¥èªŒè¨Šæ¯ï¼Œä¹Ÿéœ€è¦é¡¯ç¤ºåœ¨æˆ¿ä¸»çš„æ—¥èªŒä¸­
                if (message.type === "LOG_MESSAGE") {
                    logMessage(message.message, message.messageType);
                }
            } else if (conn) {
                conn.send(message);
            }
        }
        
        // é–‹å§‹éŠæˆ²
        function startGame() {
            if (!isHost || gameState.players.length < 2 || gameState.players.length > 5) {
                logMessage("éœ€è¦2-5åç©å®¶æ‰èƒ½é–‹å§‹éŠæˆ²", "system");
                return;
            }
            
            logMessage("éŠæˆ²è¨­ç½®ä¸­...", "system");
            showProgress("éŠæˆ²è¨­ç½®ä¸­...", 100);
            
            // åˆå§‹åŒ–ç‰Œåº«
            gameState.deck = [];
            for (const [id, card] of Object.entries(CARDS)) {
                for (let i = 0; i < card.count; i++) {
                    gameState.deck.push({
                        id: parseFloat(id),
                        name: card.name,
                        gender: card.gender,
                        effect: card.effect
                    });
                }
            }
            
            // æ´—ç‰Œ
            shuffleDeck(gameState.deck);
            
            // éš¨æ©Ÿç§»é™¤ä¸€å¼µç‰Œ
            gameState.removedCard = gameState.deck.pop();
            
            // ç™¼ç‰Œçµ¦æ¯ä½ç©å®¶
            gameState.players.forEach(player => {
                if (gameState.deck.length > 0) {
                    player.hand = [gameState.deck.pop()];
                }
                player.isProtected = false;
                player.isEliminated = false;
            });
            
            // åˆå§‹åŒ–æ£„ç‰Œå †
            gameState.discardPile = [];
            gameState.currentPlayerIndex = 0;
            gameState.phase = "playing";
            gameState.protectedPlayers = [];
            gameState.eliminatedPlayers = [];
            gameState.selectedCard = null;
            gameState.lastPlayedCard = null;
            
            // å»£æ’­éŠæˆ²é–‹å§‹
            broadcast({
                type: "START_GAME",
                gameState: gameState
            });
            
            // æ›´æ–°æˆ¿ä¸»ç•Œé¢
            startGameUI();
            updateGameDisplay();
            
            setTimeout(() => {
                hideProgress();
                logMessage("éŠæˆ²é–‹å§‹! ç•¶å‰å›åˆ: " + gameState.players[0].name, "system");
                logMessage("è«‹é»æ“Šã€ŒæŠ½ä¸€å¼µç‰Œã€é–‹å§‹ä½ çš„å›åˆ", "system");
            }, 1000);
        }
        
        // æ´—ç‰Œå‡½æ•¸
        function shuffleDeck(deck) {
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
        }
        
        // é–‹å§‹éŠæˆ²UI
        function startGameUI() {
            roomSection.style.display = "none";
            gameSection.style.display = "block";
            updateHintTable();
        }
        
        // æ›´æ–°éŠæˆ²é¡¯ç¤º
        function updateGameDisplay() {
            // æ›´æ–°ç©å®¶åˆ—è¡¨
            updatePlayersDisplay();
            
            // æ›´æ–°ç‰Œåº«æ•¸é‡
            deckCount.textContent = gameState.deck.length;
            
            // æ›´æ–°ç•¶å‰å›åˆç©å®¶
            if (gameState.currentPlayerIndex >= 0 && gameState.currentPlayerIndex < gameState.players.length) {
                currentPlayer.textContent = gameState.players[gameState.currentPlayerIndex].name;
            }
            
            // æ›´æ–°æ‰‹ç‰Œé¡¯ç¤º
            updateHandDisplay();
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            const isMyTurn = gameState.players[gameState.currentPlayerIndex] && 
                            gameState.players[gameState.currentPlayerIndex].id === playerId;
            
            document.getElementById("drawCard").disabled = !isMyTurn || gameState.selectedCard !== null;
            document.getElementById("playCard").disabled = !isMyTurn || gameState.selectedCard === null;
            document.getElementById("endTurn").disabled = !isMyTurn;
            
            // æ›´æ–°æç¤ºè¡¨
            updateHintTable();
        }
        
        // æ›´æ–°ç©å®¶é¡¯ç¤º
        function updatePlayersDisplay() {
            playersContainer.innerHTML = "";
            
            gameState.players.forEach((player, index) => {
                const playerCard = document.createElement("div");
                playerCard.className = "player-card";
                
                if (player.isHost) playerCard.classList.add("host");
                if (index === gameState.currentPlayerIndex) playerCard.classList.add("current-turn");
                if (player.isEliminated) playerCard.classList.add("eliminated");
                
                playerCard.innerHTML = `
                    <div class="player-avatar">${player.avatar}</div>
                    <div class="player-info">
                        <div class="player-name">${player.name} ${player.isHost ? "ğŸ‘‘" : ""}</div>
                        <div class="player-status">
                            ${player.isEliminated ? "âŒ å·²å‡ºå±€" : "âœ… å­˜æ´»"} 
                            ${player.isProtected ? "ğŸ›¡ï¸ å—ä¿è­·" : ""}
                            ${player.hand.length > 0 ? "ğŸƒ æœ‰æ‰‹ç‰Œ" : "ğŸƒ ç„¡æ‰‹ç‰Œ"}
                        </div>
                    </div>
                `;
                
                playersContainer.appendChild(playerCard);
            });
        }
        
        // æ›´æ–°æ‰‹ç‰Œé¡¯ç¤º
        function updateHandDisplay() {
            handContainer.innerHTML = "";
            
            // æ‰¾åˆ°ç•¶å‰ç©å®¶
            const currentPlayerObj = gameState.players.find(p => p.id === playerId);
            if (!currentPlayerObj || currentPlayerObj.isEliminated) {
                // å¦‚æœç©å®¶å·²å‡ºå±€ï¼Œé¡¯ç¤ºæ‰€æœ‰ç©å®¶çš„æ‰‹ç‰Œï¼ˆä¸Šå¸è¦–è§’ï¼‰
                gameState.players.forEach(player => {
                    if (!player.isEliminated && player.hand.length > 0) {
                        const card = player.hand[0];
                        const cardElement = createCardElement(card, false, player.id === playerId);
                        handContainer.appendChild(cardElement);
                    }
                });
                return;
            }
            
            // æ­£å¸¸é¡¯ç¤ºè‡ªå·±çš„æ‰‹ç‰Œ
            currentPlayerObj.hand.forEach((card, index) => {
                const cardElement = createCardElement(card, index === gameState.selectedCard, true);
                cardElement.addEventListener("click", () => selectCard(index));
                handContainer.appendChild(cardElement);
            });
            
            // å¦‚æœåªæœ‰ä¸€å¼µç‰Œï¼Œé¡¯ç¤ºä¸€å¼µç‰ŒèƒŒ
            if (currentPlayerObj.hand.length === 1) {
                const cardBack = document.createElement("div");
                cardBack.className = "card card-back";
                cardBack.innerHTML = `
                    <div class="card-name">ç‰ŒèƒŒ</div>
                    <i class="fas fa-question"></i>
                `;
                handContainer.appendChild(cardBack);
            }
        }
        
        // å‰µå»ºå¡ç‰‡å…ƒç´ 
        function createCardElement(card, isSelected, isOwnCard) {
            const cardElement = document.createElement("div");
            cardElement.className = "card";
            if (isSelected) cardElement.classList.add("selected");
            
            const genderIcon = card.gender === "male" ? "â™‚" : "â™€";
            const genderClass = card.gender === "male" ? "male" : "female";
            
            cardElement.innerHTML = `
                <div class="card-number">${card.id}</div>
                <div class="card-gender ${genderClass}">${genderIcon}</div>
                <div class="card-name">${card.name}</div>
                <div class="card-effect">${isOwnCard ? card.effect : "???"}</div>
            `;
            
            return cardElement;
        }
        
        // é¸æ“‡å¡ç‰‡
        function selectCard(index) {
            const currentPlayerObj = gameState.players.find(p => p.id === playerId);
            if (!currentPlayerObj || currentPlayerObj.isEliminated) return;
            
            if (gameState.selectedCard === index) {
                gameState.selectedCard = null;
            } else {
                gameState.selectedCard = index;
            }
            
            updateGameDisplay();
        }
        
        // æŠ½ç‰Œ
        function drawCard() {
            const currentPlayerObj = gameState.players.find(p => p.id === playerId);
            if (!currentPlayerObj || currentPlayerObj.isEliminated || currentPlayerObj.hand.length >= 2) {
                logMessage("ä½ ç¾åœ¨ä¸èƒ½æŠ½ç‰Œ", "system");
                return;
            }
            
            showProgress("æŠ½ç‰Œä¸­...", 50);
            
            // ç™¼é€å‹•ä½œè«‹æ±‚çµ¦ä¸»æ©Ÿ
            broadcast({
                type: "ACTION_REQUEST",
                action: "DRAW_CARD",
                playerId: playerId
            });
        }
        
        // å‡ºç‰Œ
        function playCard() {
            if (gameState.selectedCard === null) {
                logMessage("è«‹å…ˆé¸æ“‡ä¸€å¼µç‰Œ", "system");
                return;
            }
            
            const currentPlayerObj = gameState.players.find(p => p.id === playerId);
            if (!currentPlayerObj || currentPlayerObj.isEliminated) return;
            
            const selectedCard = currentPlayerObj.hand[gameState.selectedCard];
            
            showProgress(`æ‰“å‡º ${selectedCard.name}...`, 50);
            
            // ç™¼é€å‹•ä½œè«‹æ±‚çµ¦ä¸»æ©Ÿ
            broadcast({
                type: "ACTION_REQUEST",
                action: "PLAY_CARD",
                playerId: playerId,
                cardIndex: gameState.selectedCard
            });
        }
        
        // çµæŸå›åˆ
        function endTurn() {
            showProgress("çµæŸå›åˆ...", 50);
            
            broadcast({
                type: "ACTION_REQUEST",
                action: "END_TURN",
                playerId: playerId
            });
        }
        
        // è™•ç†å‹•ä½œè«‹æ±‚ï¼ˆåƒ…ä¸»æ©ŸåŸ·è¡Œï¼‰
        function handleActionRequest(data, connection) {
            const player = gameState.players.find(p => p.id === data.playerId);
            if (!player) return;
            
            switch(data.action) {
                case "DRAW_CARD":
                    if (player.hand.length >= 2) {
                        connection.send({
                            type: "LOG_MESSAGE",
                            message: "ä½ å·²ç¶“æœ‰å…©å¼µæ‰‹ç‰Œäº†",
                            messageType: "system"
                        });
                        return;
                    }
                    
                    if (gameState.deck.length === 0) {
                        // å¦‚æœç‰Œåº«æ²’ç‰Œäº†ï¼Œå°‡ç§»é™¤çš„ç‰Œé‡æ–°åŠ å…¥
                        if (gameState.removedCard) {
                            gameState.deck.push(gameState.removedCard);
                            gameState.removedCard = null;
                            shuffleDeck(gameState.deck);
                            logMessage("ç‰Œåº«å·²ç©ºï¼Œå°‡ç§»é™¤çš„ç‰Œé‡æ–°åŠ å…¥ç‰Œåº«", "system");
                        } else {
                            // éŠæˆ²çµæŸ
                            endGame();
                            return;
                        }
                    }
                    
                    player.hand.push(gameState.deck.pop());
                    logMessage(`${player.name} æŠ½äº†ä¸€å¼µç‰Œ`, "player-action");
                    
                    broadcast({
                        type: "GAME_STATE_UPDATE",
                        gameState: gameState
                    });
                    break;
                    
                case "PLAY_CARD":
                    if (data.cardIndex === undefined || data.cardIndex >= player.hand.length) return;
                    
                    const playedCard = player.hand[data.cardIndex];
                    
                    // æª¢æŸ¥æ˜¯å¦å¿…é ˆæ‰“å‡ºä¼¯çˆµå¤«äºº
                    const hasPrinceOrKing = player.hand.some(card => card.id === 6 || card.id === 7);
                    if (hasPrinceOrKing && playedCard.id !== 8) {
                        // æª¢æŸ¥æ‰‹ç‰Œä¸­æ˜¯å¦æœ‰ä¼¯çˆµå¤«äºº
                        const hasCountess = player.hand.some(card => card.id === 8);
                        if (hasCountess) {
                            connection.send({
                                type: "LOG_MESSAGE",
                                message: "ä½ æ‰‹ä¸­æœ‰ç‹å­æˆ–åœ‹ç‹èˆ‡ä¼¯çˆµå¤«äººï¼Œå¿…é ˆæ‰“å‡ºä¼¯çˆµå¤«äºº",
                                messageType: "system"
                            });
                            return;
                        }
                    }
                    
                    // å¾æ‰‹ç‰Œä¸­ç§»é™¤
                    player.hand.splice(data.cardIndex, 1);
                    
                    // æ·»åŠ åˆ°æ£„ç‰Œå †
                    gameState.discardPile.push({
                        card: playedCard,
                        player: player.name,
                        turn: gameState.currentPlayerIndex
                    });
                    
                    gameState.lastPlayedCard = playedCard;
                    
                    logMessage(`${player.name} æ‰“å‡ºäº† ${playedCard.name}`, "player-action");
                    
                    // åŸ·è¡Œå¡ç‰‡æ•ˆæœ
                    executeCardEffect(playedCard, player, connection);
                    
                    broadcast({
                        type: "GAME_STATE_UPDATE",
                        gameState: gameState
                    });
                    break;
                    
                case "END_TURN":
                    // ç§»é™¤éç•¶å‰å›åˆç©å®¶çš„ä¿è­·ç‹€æ…‹
                    gameState.protectedPlayers = gameState.protectedPlayers.filter(p => 
                        p.playerId === player.id && p.expiresAfter === gameState.currentPlayerIndex
                    );
                    
                    // åˆ‡æ›åˆ°ä¸‹ä¸€ä½ç©å®¶
                    let nextPlayerIndex = (gameState.currentPlayerIndex + 1) % gameState.players.length;
                    while (gameState.players[nextPlayerIndex].isEliminated) {
                        nextPlayerIndex = (nextPlayerIndex + 1) % gameState.players.length;
                    }
                    
                    gameState.currentPlayerIndex = nextPlayerIndex;
                    gameState.selectedCard = null;
                    
                    logMessage(`å›åˆçµæŸï¼Œç¾åœ¨æ˜¯ ${gameState.players[nextPlayerIndex].name} çš„å›åˆ`, "system");
                    
                    broadcast({
                        type: "GAME_STATE_UPDATE",
                        gameState: gameState
                    });
                    
                    // æª¢æŸ¥éŠæˆ²æ˜¯å¦çµæŸ
                    checkGameEnd();
                    break;
            }
        }
        
        // åŸ·è¡Œå¡ç‰‡æ•ˆæœ
        function executeCardEffect(card, player, connection) {
            // æ ¹æ“šå¡ç‰‡IDåŸ·è¡Œä¸åŒæ•ˆæœ
            switch(card.id) {
                case 1: // åˆºå®¢
                    // è¢«å‹•æ•ˆæœï¼Œåœ¨çŒœéŒ¯æ™‚è§¸ç™¼
                    logMessage(`${card.name} å·²æ‰“å‡ºï¼Œè¢«å‹•æ•ˆæœå·²å•Ÿç”¨`, "system");
                    break;
                    
                case 2: // è¡›å…µ
                case 2.5: // å…µé•·
                    // éœ€è¦çŒœç‰Œï¼Œç™¼é€è«‹æ±‚çµ¦ç©å®¶é¸æ“‡ç›®æ¨™å’ŒçŒœæ¸¬
                    connection.send({
                        type: "ACTION_REQUEST",
                        action: "GUESS_CARD",
                        cardId: card.id
                    });
                    break;
                    
                case 5: // ä¾å¥³
                    // çµ¦äºˆä¿è­·ç‹€æ…‹ç›´åˆ°ä¸‹æ¬¡å›åˆ
                    gameState.protectedPlayers.push({
                        playerId: player.id,
                        expiresAfter: (gameState.currentPlayerIndex + 1) % gameState.players.length
                    });
                    player.isProtected = true;
                    logMessage(`${player.name} å—åˆ° ${card.name} ä¿è­·ï¼Œç›´åˆ°ä¸‹æ¬¡å›åˆé–‹å§‹`, "system");
                    break;
                    
                case 6: // ç‹å­
                    // éœ€è¦é¸æ“‡ç›®æ¨™ç©å®¶æ£„ç‰Œ
                    connection.send({
                        type: "ACTION_REQUEST",
                        action: "SELECT_PLAYER",
                        cardId: card.id,
                        message: "é¸æ“‡ä¸€ä½ç©å®¶æ£„æ‰æ‰‹ç‰Œ"
                    });
                    break;
                    
                case 7: // åœ‹ç‹
                    // éœ€è¦é¸æ“‡ç›®æ¨™ç©å®¶äº¤æ›æ‰‹ç‰Œ
                    connection.send({
                        type: "ACTION_REQUEST",
                        action: "SELECT_PLAYER",
                        cardId: card.id,
                        message: "é¸æ“‡ä¸€ä½ç©å®¶äº¤æ›æ‰‹ç‰Œ"
                    });
                    break;
                    
                case 9: // å…¬ä¸»
                    // æ£„æ‰å…¬ä¸»ç›´æ¥å‡ºå±€ï¼ˆé€™åœ¨æ£„ç‰Œæ™‚æª¢æŸ¥ï¼‰
                    logMessage(`${card.name} å·²æ‰“å‡ºï¼Œæ£„æ‰å…¬ä¸»æœƒç›´æ¥å‡ºå±€`, "system");
                    break;
                    
                default:
                    logMessage(`${card.name} æ•ˆæœå·²åŸ·è¡Œ`, "system");
                    break;
            }
        }
        
        // æª¢æŸ¥éŠæˆ²æ˜¯å¦çµæŸ
        function checkGameEnd() {
            // æª¢æŸ¥æ˜¯å¦åªå‰©ä¸€ä½ç©å®¶æœªå‡ºå±€
            const alivePlayers = gameState.players.filter(p => !p.isEliminated);
            if (alivePlayers.length === 1) {
                endGame();
                return;
            }
            
            // æª¢æŸ¥ç‰Œåº«æ˜¯å¦æŠ½å®Œ
            if (gameState.deck.length === 0) {
                // å¦‚æœç§»é™¤çš„ç‰Œé‚„æœ‰ï¼Œé‡æ–°åŠ å…¥
                if (gameState.removedCard) {
                    gameState.deck.push(gameState.removedCard);
                    gameState.removedCard = null;
                    shuffleDeck(gameState.deck);
                    logMessage("ç‰Œåº«å·²ç©ºï¼Œå°‡ç§»é™¤çš„ç‰Œé‡æ–°åŠ å…¥ç‰Œåº«", "system");
                    broadcast({
                        type: "GAME_STATE_UPDATE",
                        gameState: gameState
                    });
                } else {
                    endGame();
                }
            }
        }
        
        // çµæŸéŠæˆ²
        function endGame() {
            gameState.phase = "ended";
            
            // æ‰¾å‡ºæœªå‡ºå±€çš„ç©å®¶
            const alivePlayers = gameState.players.filter(p => !p.isEliminated);
            
            if (alivePlayers.length === 1) {
                // åªå‰©ä¸€ä½ç©å®¶ï¼Œç›´æ¥ç²å‹
                logMessage(`éŠæˆ²çµæŸï¼${alivePlayers[0].name} ç²å‹ï¼`, "system");
            } else {
                // å¤šä½ç©å®¶æœªå‡ºå±€ï¼Œæ¯”è¼ƒæ‰‹ç‰Œæ•¸å­—å¤§å°
                logMessage("éŠæˆ²çµæŸï¼ç‰Œåº«å·²ç©ºï¼Œæ¯”è¼ƒæ‰‹ç‰Œå¤§å°...", "system");
                
                let maxCardValue = -1;
                let winners = [];
                
                alivePlayers.forEach(player => {
                    if (player.hand.length > 0) {
                        const cardValue = player.hand[0].id;
                        if (cardValue > maxCardValue) {
                            maxCardValue = cardValue;
                            winners = [player];
                        } else if (cardValue === maxCardValue) {
                            winners.push(player);
                        }
                    }
                });
                
                if (winners.length === 1) {
                    logMessage(`${winners[0].name} çš„æ‰‹ç‰Œæ•¸å­—æœ€å¤§ (${maxCardValue})ï¼Œç²å‹ï¼`, "system");
                } else {
                    const winnerNames = winners.map(w => w.name).join(", ");
                    logMessage(`${winnerNames} çš„æ‰‹ç‰Œæ•¸å­—ç›¸åŒ (${maxCardValue})ï¼Œå…±äº«å‹åˆ©ï¼`, "system");
                }
            }
            
            broadcast({
                type: "GAME_STATE_UPDATE",
                gameState: gameState
            });
            
            // é¡¯ç¤ºè¿”å›æˆ¿é–“çš„æŒ‰éˆ•
            setTimeout(() => {
                if (confirm("éŠæˆ²çµæŸï¼æ˜¯å¦è¿”å›æˆ¿é–“ï¼Ÿ")) {
                    leaveGame();
                }
            }, 2000);
        }
        
        // é›¢é–‹éŠæˆ²
        function leaveGame() {
            gameSection.style.display = "none";
            roomSection.style.display = "block";
            
            // é‡ç½®éŠæˆ²ç‹€æ…‹
            if (isHost) {
                gameState = {
                    players: gameState.players.map(p => ({
                        ...p,
                        hand: [],
                        isProtected: false,
                        isEliminated: false
                    })),
                    deck: [],
                    discardPile: [],
                    currentPlayerIndex: -1,
                    phase: "waiting",
                    selectedCard: null,
                    lastPlayedCard: null,
                    protectedPlayers: [],
                    eliminatedPlayers: [],
                    removedCard: null
                };
                
                broadcast({
                    type: "GAME_STATE_UPDATE",
                    gameState: gameState
                });
                
                updatePlayersDisplay();
            }
        }
        
        // é›¢é–‹æˆ¿é–“
        function leaveRoom() {
            if (peer) {
                peer.destroy();
                peer = null;
            }
            
            conn = null;
            hostConnections = [];
            isHost = false;
            
            document.getElementById("joinRoom").disabled = false;
            document.getElementById("leaveRoom").disabled = true;
            document.getElementById("startGame").disabled = true;
            document.getElementById("playerName").disabled = false;
            document.getElementById("roomId").disabled = false;
            
            // é‡ç½®ç©å®¶åˆ—è¡¨
            playersContainer.innerHTML = `
                <div class="text-center" style="grid-column: 1 / -1; padding: 20px; color: var(--light-gold);">
                    ç­‰å¾…ç©å®¶åŠ å…¥æˆ¿é–“...
                </div>
            `;
            
            // éš±è—éŠæˆ²å€åŸŸ
            gameSection.style.display = "none";
            roomSection.style.display = "block";
            
            logMessage("å·²é›¢é–‹æˆ¿é–“", "system");
        }
        
        // é¡¯ç¤ºæç¤ºå¡/å‰©é¤˜ç‰Œè¡¨
        function showHint() {
            document.getElementById("hintModal").style.display = "flex";
        }
        
        // éš±è—æç¤ºå¡
        function hideHint() {
            document.getElementById("hintModal").style.display = "none";
        }
        
        // æ›´æ–°æç¤ºè¡¨
        function updateHintTable() {
            cardsTableBody.innerHTML = "";
            
            // è¨ˆç®—æ¯ç¨®å¡ç‰Œçš„å‰©é¤˜æ•¸é‡
            const cardCounts = {};
            
            // åˆå§‹åŒ–
            for (const [id, card] of Object.entries(CARDS)) {
                cardCounts[id] = {
                    total: card.count,
                    remaining: card.count
                };
            }
            
            // æ¸›å»ç‰Œåº«ä¸­çš„ç‰Œ
            gameState.deck.forEach(card => {
                if (cardCounts[card.id]) {
                    cardCounts[card.id].remaining--;
                }
            });
            
            // æ¸›å»ç©å®¶æ‰‹ä¸­çš„ç‰Œ
            gameState.players.forEach(player => {
                player.hand.forEach(card => {
                    if (cardCounts[card.id]) {
                        cardCounts[card.id].remaining--;
                    }
                });
            });
            
            // æ¸›å»æ£„ç‰Œå †ä¸­çš„ç‰Œ
            gameState.discardPile.forEach(discard => {
                if (cardCounts[discard.card.id]) {
                    cardCounts[discard.card.id].remaining--;
                }
            });
            
            // æ¸›å»ç§»é™¤çš„ç‰Œ
            if (gameState.removedCard && cardCounts[gameState.removedCard.id]) {
                cardCounts[gameState.removedCard.id].remaining--;
            }
            
            // ç”Ÿæˆè¡¨æ ¼è¡Œ
            for (const [id, card] of Object.entries(CARDS)) {
                const row = document.createElement("tr");
                
                const remaining = cardCounts[id] ? cardCounts[id].remaining : 0;
                const remainingClass = remaining > 0 ? "" : "style='color: var(--red);'";
                
                row.innerHTML = `
                    <td>${id}</td>
                    <td>${card.name}</td>
                    <td>${card.gender === "male" ? "â™‚ ç”·" : "â™€ å¥³"}</td>
                    <td>${card.count}</td>
                    <td ${remainingClass}>${remaining}</td>
                    <td>${card.effect}</td>
                `;
                
                cardsTableBody.appendChild(row);
            }
        }
        
        // æŸ¥çœ‹æ£„ç‰Œå †
        function viewDiscard() {
            if (gameState.discardPile.length === 0) {
                logMessage("æ£„ç‰Œå †æ˜¯ç©ºçš„", "system");
                return;
            }
            
            let discardText = "æ£„ç‰Œå †: ";
            gameState.discardPile.forEach((discard, index) => {
                if (index > 0) discardText += ", ";
                discardText += `${discard.card.name} (${discard.player})`;
            });
            
            logMessage(discardText, "system");
        }
        
        // æ“²éª°å­å°éŠæˆ²
        function rollDice() {
            const dice1 = Math.floor(Math.random() * 6) + 1;
            const dice2 = Math.floor(Math.random() * 6) + 1;
            const total = dice1 + dice2;
            
            document.getElementById("dice1").textContent = getDiceFace(dice1);
            document.getElementById("dice2").textContent = getDiceFace(dice2);
            
            const resultText = `ä½ æ“²å‡ºäº† ${dice1} å’Œ ${dice2} (ç¸½å’Œ: ${total})`;
            document.getElementById("diceResult").innerHTML = `<strong>${resultText}</strong>`;
            
            // å¦‚æœæ˜¯ä¸»æ©Ÿï¼Œå»£æ’­çµæœ
            if (isHost) {
                broadcast({
                    type: "DICE_ROLL_RESULT",
                    playerName: playerName,
                    dice1: getDiceFace(dice1),
                    dice2: getDiceFace(dice2),
                    total: total
                });
            } else if (conn) {
                conn.send({
                    type: "DICE_ROLL_RESULT",
                    playerName: playerName,
                    dice1: getDiceFace(dice1),
                    dice2: getDiceFace(dice2),
                    total: total
                });
            }
        }
        
        // ç²å–éª°å­è¡¨æƒ…
        function getDiceFace(number) {
            const faces = ["?", "âš€", "âš", "âš‚", "âšƒ", "âš„", "âš…"];
            return faces[number] || "?";
        }
        
        // é¡¯ç¤ºé€²åº¦æ¢
        function showProgress(message, duration) {
            progressBar.textContent = message;
            progressBar.style.width = "0%";
            progressContainer.style.display = "block";
            
            setTimeout(() => {
                progressBar.style.width = "100%";
            }, 10);
            
            // ç¦ç”¨æŒ‰éˆ•
            document.querySelectorAll("button").forEach(btn => {
                if (!btn.id || !["leaveRoom", "closeHint"].includes(btn.id)) {
                    btn.disabled = true;
                }
            });
            
            // è¨­ç½®å®šæ™‚å™¨éš±è—é€²åº¦æ¢
            setTimeout(hideProgress, duration);
        }
        
        // éš±è—é€²åº¦æ¢
        function hideProgress() {
            progressContainer.style.display = "none";
            
            // é‡æ–°å•Ÿç”¨æŒ‰éˆ•
            document.querySelectorAll("button").forEach(btn => {
                if (!btn.id || !["leaveRoom", "closeHint"].includes(btn.id)) {
                    btn.disabled = false;
                }
            });
            
            updateGameDisplay();
        }
        
        // è¨˜éŒ„è¨Šæ¯
        function logMessage(message, type = "system") {
            const logEntry = document.createElement("div");
            logEntry.className = `log-entry ${type}`;
            
            const icon = type === "system" ? "fas fa-info-circle" : 
                        type === "player-action" ? "fas fa-user" : 
                        type === "elimination" ? "fas fa-skull-crossbones" : "fas fa-comment";
            
            logEntry.innerHTML = `<i class="${icon}"></i> ${message}`;
            
            gameLog.appendChild(logEntry);
            
            // è‡ªå‹•æ»¾å‹•åˆ°åº•éƒ¨
            gameLog.scrollTop = gameLog.scrollHeight;
        }
        
        // æ¸…ç©ºæ—¥èªŒ
        function clearLog() {
            gameLog.innerHTML = `<div class="log-entry system">
                <i class="fas fa-info-circle"></i> æ—¥èªŒå·²æ¸…ç©º
            </div>`;
        }
    </script>
</body>
</html>
