<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã€æƒ…æ›¸ã€‘v0.7 - ç©©å®šé€£ç·šç‰ˆ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root {
            --dark-brown: #2c1b0f;
            --medium-brown: #4a3728;
            --light-brown: #7a5c3c;
            --gold: #d4af37;
            --light-gold: #f4e4b5;
            --dark-gold: #b8941f;
            --red: #8b0000;
            --green: #006400;
            --text-light: #f5deb3;
            --text-dark: #3d2c1e;
            --card-bg: #f8f1e5;
            --shadow: rgba(0, 0, 0, 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(to bottom, var(--dark-brown), var(--medium-brown));
            color: var(--text-light);
            min-height: 100vh;
            padding: 10px;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* æ¨™é¡Œå€åŸŸ */
        header {
            text-align: center;
            padding: 15px;
            border-bottom: 2px solid var(--gold);
            margin-bottom: 20px;
            background-color: rgba(44, 27, 15, 0.8);
            border-radius: 10px;
            box-shadow: 0 5px 15px var(--shadow);
        }

        h1 {
            color: var(--gold);
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px var(--shadow);
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.2rem;
            color: var(--light-gold);
            margin-bottom: 15px;
        }

        /* ä¸»éŠæˆ²å€åŸŸ */
        .game-area {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* æˆ¿é–“å€åŸŸ */
        .room-section {
            background-color: rgba(74, 55, 40, 0.9);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px var(--shadow);
            border: 1px solid var(--light-brown);
        }

        .room-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            min-width: 200px;
        }

        label {
            margin-bottom: 5px;
            color: var(--light-gold);
            font-weight: bold;
        }

        input, select, button {
            padding: 12px 15px;
            border-radius: 5px;
            border: 1px solid var(--light-brown);
            font-size: 1rem;
        }

        input, select {
            background-color: var(--card-bg);
            color: var(--text-dark);
        }

        button {
            background-color: var(--gold);
            color: var(--dark-brown);
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        button:hover:not(:disabled) {
            background-color: var(--light-gold);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            filter: grayscale(1);
        }

        .danger-btn {
            background-color: var(--red);
            color: white;
        }

        .success-btn {
            background-color: var(--green);
            color: white;
        }

        /* ç©å®¶åˆ—è¡¨ */
        .players-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .player-card {
            background-color: rgba(122, 92, 60, 0.7);
            border-radius: 8px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            border: 3px solid transparent;
            transition: all 0.3s;
            position: relative;
        }

        .player-card.host {
            border-color: var(--light-gold);
        }
        
        .player-card.host::after {
            content: 'ğŸ‘‘';
            position: absolute;
            top: -10px;
            right: -5px;
            font-size: 1.5rem;
        }

        .player-card.current-turn {
            border-color: var(--gold);
            box-shadow: 0 0 20px var(--gold), inset 0 0 10px var(--gold);
            background-color: rgba(184, 148, 31, 0.4);
            animation: pulse-border 1.5s infinite;
            z-index: 10;
        }

        .player-card.eliminated {
            opacity: 0.6;
            filter: grayscale(0.8);
            border-color: var(--red);
            background-color: rgba(50, 0, 0, 0.5);
        }

        .player-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            background-color: var(--dark-brown);
            border: 2px solid var(--light-brown);
        }

        .player-info {
            flex-grow: 1;
        }

        .player-name {
            font-weight: bold;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .player-status {
            font-size: 0.9rem;
            color: var(--light-gold);
        }
        
        .turn-badge {
            display: none;
            background-color: var(--gold);
            color: var(--dark-brown);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            margin-left: auto;
            font-weight: bold;
        }
        
        .player-card.current-turn .turn-badge {
            display: inline-block;
        }

        /* éŠæˆ²å€åŸŸ */
        .game-section {
            display: none;
            background-color: rgba(74, 55, 40, 0.9);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px var(--shadow);
            border: 1px solid var(--light-brown);
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--light-brown);
        }

        .game-info {
            display: flex;
            gap: 20px;
            font-size: 1.1rem;
        }

        .deck-info, .turn-info {
            background-color: rgba(44, 27, 15, 0.7);
            padding: 10px 15px;
            border-radius: 5px;
            border: 1px solid var(--light-brown);
        }

        /* æ‰‹ç‰Œå€åŸŸ */
        .hand-container {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 30px 0;
            flex-wrap: wrap;
            min-height: 260px;
        }

        .card {
            width: 180px;
            height: 250px;
            background-color: var(--card-bg);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            color: var(--text-dark);
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 8px 16px var(--shadow);
            border: 4px solid #8B4513;
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-15px) scale(1.05);
            box-shadow: 0 20px 30px rgba(0,0,0,0.6);
            z-index: 5;
        }

        .card.selected {
            border-color: var(--gold);
            box-shadow: 0 0 25px var(--gold);
            transform: translateY(-20px);
            animation: float 2s infinite ease-in-out;
        }

        .card.played {
            opacity: 0.5;
            cursor: default;
        }

        .card-number {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: var(--gold);
            color: var(--dark-brown);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.3);
        }

        .card-gender {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5rem;
        }

        .male { color: #1e90ff; }
        .female { color: #ff69b4; }

        .card-name {
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            margin-top: 25px;
            color: var(--dark-brown);
            border-bottom: 2px solid var(--light-brown);
            width: 100%;
            padding-bottom: 5px;
        }

        .card-effect {
            font-size: 0.85rem;
            text-align: center;
            margin-top: 10px;
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 5px;
            line-height: 1.3;
        }

        .card-back {
            background: linear-gradient(135deg, var(--dark-brown) 0%, var(--light-brown) 100%);
            color: var(--light-gold);
            justify-content: center;
            font-size: 3rem;
            border: 4px solid var(--gold);
        }

        .card-back .card-name {
            color: var(--light-gold);
            border-bottom-color: var(--gold);
        }

        /* éŠæˆ²æ§åˆ¶å€ */
        .game-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .action-btn {
            min-width: 180px;
            padding: 15px;
            font-size: 1.1rem;
        }
        
        .card-target-btn {
            background-color: var(--light-brown);
            color: white;
            padding: 10px 15px;
            border: 1px solid var(--gold);
            cursor: pointer;
            border-radius: 5px;
            transition: 0.2s;
        }
        
        .card-target-btn:hover {
            background-color: var(--gold);
            color: var(--dark-brown);
        }

        /* é€²åº¦æ¢ */
        .progress-container {
            width: 100%;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            margin: 20px 0;
            overflow: hidden;
            display: none;
        }

        .progress-bar {
            height: 20px;
            background: linear-gradient(to right, var(--dark-gold), var(--gold));
            width: 0%;
            transition: width 0.5s;
            text-align: center;
            color: var(--dark-brown);
            font-weight: bold;
            line-height: 20px;
        }

        /* æ—¥èªŒå€åŸŸ */
        .log-section {
            background-color: rgba(44, 27, 15, 0.9);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px var(--shadow);
            border: 1px solid var(--light-brown);
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: var(--gold);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
        }

        .log-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .log-entry {
            padding: 10px;
            border-radius: 5px;
            background-color: rgba(122, 92, 60, 0.5);
            border-left: 4px solid var(--gold);
            font-size: 0.95rem;
        }

        .log-entry.system { border-left-color: var(--light-gold); font-style: italic; }
        .log-entry.player-action { border-left-color: var(--green); }
        .log-entry.elimination { border-left-color: var(--red); background-color: rgba(139, 0, 0, 0.2); }
        .log-entry.important { border-left-color: #ff4500; font-weight: bold; }

        /* æç¤ºå¡/å‰©é¤˜ç‰Œè¡¨ */
        .hint-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .hint-content {
            background-color: var(--medium-brown);
            border-radius: 10px;
            padding: 30px;
            width: 95%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            border: 3px solid var(--gold);
            position: relative;
        }

        .close-hint {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: var(--light-gold);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .hint-title {
            color: var(--gold);
            font-size: 2rem;
            margin-bottom: 20px;
            text-align: center;
        }

        .cards-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.9rem;
        }

        .cards-table th, .cards-table td {
            border: 1px solid var(--light-brown);
            padding: 10px;
            text-align: center;
        }

        .cards-table th {
            background-color: var(--dark-brown);
            color: var(--gold);
        }

        .cards-table td {
            background-color: rgba(248, 241, 229, 0.1);
        }
        
        .count-badge {
            display: inline-block;
            background-color: var(--dark-brown);
            color: var(--gold);
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: bold;
        }

        /* å¾…æ©Ÿæˆ¿å°éŠæˆ² */
        .waiting-room {
            background-color: rgba(44, 27, 15, 0.9);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
            border: 1px solid var(--light-brown);
        }

        .waiting-title { color: var(--gold); font-size: 1.5rem; margin-bottom: 15px; }

        .dice {
            width: 60px;
            height: 60px;
            background-color: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: var(--dark-brown);
            box-shadow: 0 5px 10px var(--shadow);
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .room-controls { flex-direction: column; }
            .input-group { width: 100%; }
            .hand-container { flex-direction: column; align-items: center; }
            .game-header { flex-direction: column; gap: 15px; }
            .cards-table { font-size: 0.8rem; }
            .cards-table th, .cards-table td { padding: 5px; }
        }

        /* å‹•ç•« */
        @keyframes pulse-border {
            0% { box-shadow: 0 0 10px var(--gold); }
            50% { box-shadow: 0 0 25px var(--gold), 0 0 40px var(--gold); }
            100% { box-shadow: 0 0 10px var(--gold); }
        }
        
        @keyframes float {
            0% { transform: translateY(-20px); }
            50% { transform: translateY(-25px); }
            100% { transform: translateY(-20px); }
        }

        .hidden { display: none !important; }
        .visible { display: block !important; }
        .mt-20 { margin-top: 20px; }
        
        /* è¤‡è£½æŒ‰éˆ•æ¨£å¼ */
        .copy-btn {
            background-color: var(--light-brown);
            color: white;
            padding: 8px 12px;
            font-size: 0.9rem;
            margin-left: 5px;
        }
        
        .copy-btn:hover {
            background-color: var(--gold);
        }
        
        .room-id-display {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .room-id-box {
            flex-grow: 1;
            background-color: var(--dark-brown);
            padding: 10px;
            border-radius: 5px;
            border: 1px solid var(--gold);
            font-family: monospace;
            font-size: 1.1rem;
            color: var(--light-gold);
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-crown"></i> ã€æƒ…æ›¸ã€‘v0.7</h1>
            <div class="subtitle">ç©©å®šé€£ç·šç‰ˆï¼šä½¿ç”¨ PeerJS è‡ªå‹•ç”Ÿæˆå”¯ä¸€IDï¼Œé¿å…é€£ç·šè¡çª</div>
        </header>
        
        <div class="game-area">
            <section class="room-section" id="roomSection">
                <h2><i class="fas fa-home"></i> éŠæˆ²å¤§å»³</h2>
                <div class="room-controls">
                    <div class="input-group">
                        <label for="playerName">ä½ çš„åå­—</label>
                        <input type="text" id="playerName" placeholder="è¼¸å…¥ä½ çš„åå­—" value="ç©å®¶">
                    </div>
                    
                    <div class="input-group">
                        <label for="roomId">æˆ¿é–“IDï¼ˆåŠ å…¥æ™‚è¼¸å…¥ï¼‰</label>
                        <input type="text" id="roomId" placeholder="è¼¸å…¥æˆ¿ä¸»çš„IDä»¥åŠ å…¥æˆ¿é–“">
                    </div>
                    
                    <div class="input-group">
                        <label for="avatar">é¸æ“‡é ­åƒ</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <div id="avatarDisplay" class="player-avatar">ğŸ˜Š</div>
                            <button id="randomAvatar" style="flex-grow: 1;">éš¨æ©Ÿ</button>
                        </div>
                    </div>
                    
                    <button id="createRoom" class="success-btn">
                        <i class="fas fa-plus-circle"></i> å‰µå»ºæˆ¿é–“
                    </button>
                    
                    <button id="joinRoom" class="success-btn">
                        <i class="fas fa-door-open"></i> åŠ å…¥æˆ¿é–“
                    </button>
                    
                    <button id="startGame" class="success-btn" disabled>
                        <i class="fas fa-play"></i> é–‹å§‹éŠæˆ²
                    </button>
                    
                    <button id="leaveRoom" class="danger-btn" disabled>
                        <i class="fas fa-sign-out-alt"></i> é›¢é–‹æˆ¿é–“
                    </button>
                </div>
                
                <!-- æˆ¿é–“IDé¡¯ç¤ºå€ï¼ˆå‰µå»ºæˆ¿é–“å¾Œé¡¯ç¤ºï¼‰ -->
                <div id="roomIdDisplay" class="hidden">
                    <h3><i class="fas fa-key"></i> ä½ çš„æˆ¿é–“ID</h3>
                    <div class="room-id-display">
                        <div id="roomIdBox" class="room-id-box">ç­‰å¾…ç”Ÿæˆ...</div>
                        <button id="copyRoomId" class="copy-btn">
                            <i class="fas fa-copy"></i> è¤‡è£½
                        </button>
                    </div>
                    <p style="margin-top: 10px; color: var(--light-gold); font-size: 0.9rem;">
                        è«‹å°‡æ­¤IDåˆ†äº«çµ¦æœ‹å‹ï¼Œè®“ä»–å€‘è¼¸å…¥æ­¤IDä¾†åŠ å…¥æˆ¿é–“
                    </p>
                </div>
                
                <div class="players-container" id="playersContainer">
                    <div class="text-center" style="grid-column: 1 / -1; padding: 20px; color: var(--light-gold);">
                        è«‹è¼¸å…¥åå­—ä¸¦å‰µå»ºæˆ–åŠ å…¥æˆ¿é–“...
                    </div>
                </div>
                
                <div class="waiting-room" id="waitingRoomArea">
                    <div class="waiting-title">ç­‰å¾…éŠæˆ²é–‹å§‹...</div>
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
                        <p>ç­‰å¾…æ™‚å¯ä»¥æ“²éª°å­æ¯”å¤§å°</p>
                        <div style="display: flex; gap: 20px; margin: 10px 0;">
                            <div class="dice" id="dice1">?</div>
                            <div class="dice" id="dice2">?</div>
                        </div>
                        <button id="rollDice"><i class="fas fa-dice"></i> æ“²éª°å­</button>
                        <div id="diceResult" style="height: 20px; color: var(--gold);"></div>
                    </div>
                </div>
            </section>
            
            <section class="game-section" id="gameSection">
                <div class="game-header">
                    <div>
                        <h2><i class="fas fa-chess-board"></i> éŠæˆ²é€²è¡Œä¸­</h2>
                        <div class="game-info">
                            <div class="deck-info">
                                <i class="fas fa-layer-group"></i> ç‰Œåº«å‰©é¤˜: <span id="deckCount" style="color: var(--gold); font-weight: bold;">0</span>
                            </div>
                            <div class="turn-info">
                                <i class="fas fa-user-clock"></i> ç•¶å‰å›åˆ: <span id="currentPlayerName" style="color: var(--green); font-weight: bold;">-</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button id="showHint">
                            <i class="fas fa-list-ol"></i> è¨˜ç‰Œè¡¨
                        </button>
                    </div>
                </div>
                
                <div class="hand-container" id="handContainer">
                    </div>
                
                <div class="game-controls">
                    <button id="drawCard" class="action-btn" disabled>
                        <i class="fas fa-hand-paper"></i> æŠ½ä¸€å¼µç‰Œ
                    </button>
                    <button id="playCard" class="action-btn" disabled>
                        <i class="fas fa-play-circle"></i> æ‰“å‡ºé¸ä¸­çš„ç‰Œ
                    </button>
                    <div id="turnInstruction" style="width: 100%; text-align: center; margin-top: 10px; color: var(--light-gold); font-style: italic;">
                        ç­‰å¾…å…¶ä»–ç©å®¶è¡Œå‹•...
                    </div>
                </div>
                
                <div id="playerSelection" class="hidden" style="margin-top: 20px; padding: 20px; background-color: rgba(44, 27, 15, 0.7); border-radius: 10px; border: 1px solid var(--gold);">
                    <h3 style="color: var(--gold); margin-bottom: 10px;">é¸æ“‡ç›®æ¨™ç©å®¶</h3>
                    <div id="selectablePlayers" style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;"></div>
                    <div style="text-align: center; margin-top: 15px;">
                        <button id="cancelSelection" class="danger-btn">å–æ¶ˆ</button>
                    </div>
                </div>
                
                <div id="guessSelection" class="hidden" style="margin-top: 20px; padding: 20px; background-color: rgba(44, 27, 15, 0.7); border-radius: 10px; border: 1px solid var(--gold);">
                    <h3 style="color: var(--gold); margin-bottom: 10px;">çŒœæ¸¬ <span id="guessTargetName">-</span> çš„æ‰‹ç‰Œ</h3>
                    <div id="guessOptions" style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;"></div>
                    <div style="text-align: center; margin-top: 15px;">
                        <button id="cancelGuess" class="danger-btn">å–æ¶ˆ</button>
                    </div>
                </div>
            </section>
            
            <section class="log-section">
                <div class="log-title">
                    <span><i class="fas fa-scroll"></i> éŠæˆ²ç´€éŒ„</span>
                    <button id="clearLog" style="background: none; border: none; color: var(--light-gold); font-size: 0.9rem;">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
                <div class="log-content" id="gameLog">
                    <div class="log-entry system">
                        <i class="fas fa-info-circle"></i> æ­¡è¿ä¾†åˆ°æƒ…æ›¸ v0.7ï¼è«‹å‰µå»ºæˆ–åŠ å…¥æˆ¿é–“ã€‚
                    </div>
                </div>
            </section>
        </div>
    </div>
    
    <div class="hint-modal" id="hintModal">
        <div class="hint-content">
            <button class="close-hint" id="closeHint">&times;</button>
            <h2 class="hint-title">å‰©é¤˜å¡ç‰Œè¨˜ç‰Œå™¨</h2>
            <p style="text-align: center; margin-bottom: 15px; color: var(--light-gold);">
                è¨ˆç®—å…¬å¼ï¼šç¸½å¼µæ•¸ - æ£„ç‰Œå †å‡ºç¾çš„å¼µæ•¸ (ä¸å«åˆå§‹æš—ç‰Œèˆ‡å°æ‰‹æ‰‹ç‰Œ)
            </p>
            <table class="cards-table">
                <thead>
                    <tr>
                        <th width="10%">é»æ•¸</th>
                        <th width="20%">è§’è‰²</th>
                        <th width="10%">ç¸½æ•¸</th>
                        <th width="10%">å‰©é¤˜</th>
                        <th width="50%">æŠ€èƒ½</th>
                    </tr>
                </thead>
                <tbody id="cardsTableBody">
                    </tbody>
            </table>
        </div>
    </div>
    
    <script>
        // --- 1. éŠæˆ²è³‡æ–™è¨­å®š ---
        const CARDS = {
            1: { name: "åˆºå®¢", gender: "male", count: 3, effect: "æŒæœ‰é€™å¼µç‰Œæ™‚ï¼Œè‹¥æœ‰äººçŒœéŒ¯ä½ çš„èº«åˆ†ï¼Œå°æ–¹å‡ºå±€ï¼Œä½ æ£„æ‰æ­¤æ‰‹ç‰Œï¼Œå†æŠ½ä¸€å¼µ" },
            2: { name: "è¡›å…µ", gender: "female", count: 5, effect: "çŒœä»»ä¸€å€‹ç©å®¶çš„æ‰‹ç‰Œï¼ŒçŒœå°è©²ç©å®¶å‡ºå±€ï¼ŒçŒœéŒ¯æ²’äº‹ã€‚ä¸å¯ä»¥çŒœ2è™Ÿã€‚" },
            2.5: { name: "å…µé•·", gender: "female", count: 1, effect: "çŒœæ¯ä¸€å€‹ç©å®¶çš„æ‰‹ç‰Œï¼ŒçŒœå°è©²ç©å®¶å‡ºå±€ï¼ŒçŒœéŒ¯æ²’äº‹ã€‚ä¸å¯ä»¥çŒœ2è™Ÿã€‚" },
            3: { name: "ç¥çˆ¶", gender: "male", count: 2, effect: "ç§åº•ä¸‹æŸ¥çœ‹ä»»ä¸€ä½ç©å®¶çš„æ‰‹ç‰Œï¼Œä¸å¯ä»¥å…¬é–‹çµ¦å…¶ä»–ç©å®¶ã€‚" },
            3.5: { name: "é‚±æ¯”ç‰¹", gender: "male", count: 2, effect: "ç§åº•ä¸‹èˆ‡ä»»ä¸€ä½ç©å®¶ç”¨æ‰‹ç‰Œæ¯”å¤§å°ï¼ŒåŒæ€§æ™‚ï¼Œæ•¸å­—å°çš„ç©å®¶å‡ºå±€ï¼Œç•°æ€§æ™‚ï¼Œæ•¸å­—å¤§çš„ç©å®¶å‡ºå±€ï¼Œå¹³æ‰‹æ²’äº‹ã€‚" },
            4: { name: "ç”·çˆµ", gender: "male", count: 2, effect: "ç§åº•ä¸‹èˆ‡ä»»ä¸€ä½ç©å®¶ç”¨æ‰‹ç‰Œæ¯”å¤§å°ï¼Œæ•¸å­—å°çš„ç©å®¶å‡ºå±€ï¼Œå¹³æ‰‹æ²’äº‹ã€‚" },
            4.5: { name: "é è¨€å®¶", gender: "female", count: 2, effect: "æŠ½ä¸€å¼µç‰Œï¼Œå°‡æ­¤ç‰Œæˆ–æ‰‹ç‰Œå…¶ä¸€æ”¾å…¥ç‰Œåº«æœ€ä¸‹æ–¹" },
            5: { name: "ä¾å¥³", gender: "female", count: 2, effect: "æ‰“å‡ºæ­¤å¡çš„ç©å®¶ï¼Œåœ¨ä¸‹æ¬¡è¼ªåˆ°ä»–ä¹‹å‰ï¼Œéƒ½æ˜¯ç„¡æ•µçš„ç‹€æ…‹ï¼Œå…¶ä»–ç©å®¶ä¸å¯ä»¥å°ä»–ä½¿ç”¨æŠ€èƒ½ã€‚" },
            5.5: { name: "å°ä¸‘", gender: "male", count: 2, effect: "ä½¿ç”¨å…¶é¤˜ç©å®¶æœ€å¾Œæ‰“å‡ºçš„ç‰Œï¼Œè‹¥å ´ä¸Šç„¡ç‰Œï¼Œå‰‡æ²’æœ‰æ•ˆæœ" },
            6: { name: "ç‹å­", gender: "male", count: 1, effect: "æŒ‡å®šä»»ä¸€ä½ç©å®¶é¢æœä¸Šæ£„æ‰æ‰‹ç‰Œï¼Œä¸¦å†æŠ½ä¸€å¼µæ–°ç‰Œã€‚å¯ä»¥æŒ‡å®šè‡ªå·±ã€‚" },
            7: { name: "åœ‹ç‹", gender: "male", count: 1, effect: "èˆ‡ä»»ä¸€ä½ç©å®¶äº¤æ›æ‰‹ç‰Œã€‚" },
            8: { name: "ä¼¯çˆµå¤«äºº", gender: "female", count: 1, effect: "ç•¶ç©å®¶æ‰‹ä¸­æœ‰ç‹å­æˆ–åœ‹ç‹èˆ‡å…¬çˆµå¤«äººï¼Œå¿…é ˆæ‰“å‡ºå…¬çˆµå¤«äººï¼Œä¸å¯ä»¥æ‰“å‡ºç‹å­æˆ–åœ‹ç‹ã€‚" },
            9: { name: "å…¬ä¸»", gender: "female", count: 1, effect: "ç©å®¶è‹¥æ£„æ‰è©²ç‰Œï¼Œç›´æ¥å‡ºå±€ã€‚åœ¨æ¯”å¤§å°æ™‚å¿…å‹(åŒ…å«é‚±æ¯”ç‰¹)" }
        };
        
        const EMOJIS = ["ğŸ˜€", "ğŸ˜", "ğŸ¤ ", "ğŸ§", "ğŸ¤©", "ğŸ¥³", "ğŸ˜‡", "ğŸ˜ˆ", "ğŸ‘»", "ğŸ¤–", "ğŸ‘½", "ğŸ¶", "ğŸ±", "ğŸ¼", "ğŸ¦Š"];
        
        // --- 2. å…¨åŸŸè®Šæ•¸ ---
        let peer = null;
        let conn = null;
        let hostConnections = [];
        let isHost = false;
        let myPlayerId = null;
        let myName = "ç©å®¶";
        let myAvatar = "ğŸ˜Š";
        let currentRoomId = "";
        let hostPeerId = ""; // æˆ¿ä¸»çš„PeerIDï¼ˆå…¶ä»–ç©å®¶ä½¿ç”¨é€™å€‹ä¾†é€£æ¥ï¼‰

        // éŠæˆ²ç‹€æ…‹
        let gameState = {
            players: [],
            deck: [],
            discardPile: [],
            currentPlayerIndex: 0,
            phase: "waiting",
            logs: []
        };

        let selectedHandIndex = -1;
        let tempTargetPlayerId = null;

        // --- ã€ç©©å®šé€£ç·šã€‘æ ¸å¿ƒé…ç½® (ä¿ç•™ STUN ä¼ºæœå™¨) ---
        const PEER_CONFIG = {
            debug: 1,
            config: {
                'iceServers': [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'stun:stun2.l.google.com:19302' }
                ]
            }
        };

        // --- 3. åˆå§‹åŒ–èˆ‡äº‹ä»¶ ---
        document.addEventListener("DOMContentLoaded", () => {
            // ç¶å®šæŒ‰éˆ•
            document.getElementById("randomAvatar").onclick = randomizeAvatar;
            document.getElementById("createRoom").onclick = createRoom;
            document.getElementById("joinRoom").onclick = joinRoom;
            document.getElementById("startGame").onclick = tryStartGame;
            document.getElementById("leaveRoom").onclick = handleLeaveRoom; 
            document.getElementById("showHint").onclick = updateAndShowHint;
            document.getElementById("closeHint").onclick = () => document.getElementById("hintModal").style.display = "none";
            document.getElementById("hintModal").onclick = (e) => { if(e.target.id === "hintModal") document.getElementById("hintModal").style.display = "none"; };
            
            document.getElementById("drawCard").onclick = actionDrawCard;
            document.getElementById("playCard").onclick = preparePlayCard;
            document.getElementById("cancelSelection").onclick = resetSelectionUI;
            document.getElementById("cancelGuess").onclick = resetSelectionUI;
            document.getElementById("clearLog").onclick = () => document.getElementById("gameLog").innerHTML = '<div class="log-entry system"><i class="fas fa-info-circle"></i> æ—¥èªŒå·²æ¸…ç©º</div>';
            document.getElementById("rollDice").onclick = playDiceGame;
            document.getElementById("copyRoomId").onclick = copyRoomId;
            
            randomizeAvatar();
        });

        function randomizeAvatar() {
            myAvatar = EMOJIS[Math.floor(Math.random() * EMOJIS.length)];
            document.getElementById("avatarDisplay").textContent = myAvatar;
            if(gameState.phase === "waiting" && myPlayerId) {
                sendData({type: "UPDATE_PROFILE", name: myName, avatar: myAvatar});
            }
        }

        // --- 4. æ–°çš„é€£ç·šé‚è¼¯ (v0.7 æ ¸å¿ƒä¿®æ”¹) ---
        function createRoom() {
            myName = document.getElementById("playerName").value || "ç©å®¶";
            
            document.getElementById("createRoom").disabled = true;
            document.getElementById("joinRoom").disabled = true;
            document.getElementById("playerName").disabled = true;
            
            // å‰µå»º Peer å°è±¡ï¼Œä¸å¸¶åƒæ•¸è®“ PeerJS è‡ªå‹•ç”Ÿæˆå”¯ä¸€ ID
            peer = new Peer(null, PEER_CONFIG);
            
            peer.on('open', (id) => {
                // æˆåŠŸå‰µå»ºæˆ¿é–“ï¼Œid æ˜¯ PeerJS è‡ªå‹•ç”Ÿæˆçš„å”¯ä¸€ ID
                isHost = true;
                myPlayerId = id;
                hostPeerId = id; // é€™æ˜¯æˆ¿ä¸»çš„ PeerIDï¼Œå…¶ä»–ç©å®¶è¦ç”¨é€™å€‹ä¾†é€£æ¥
                
                logSystem(`æˆ¿é–“å·²å»ºç«‹ï¼`);
                logSystem(`ä½ çš„æˆ¿é–“ID: ${id}`);
                
                // é¡¯ç¤ºæˆ¿é–“ID
                document.getElementById("roomIdBox").textContent = id;
                document.getElementById("roomIdDisplay").classList.remove("hidden");
                
                document.getElementById("startGame").disabled = false;
                document.getElementById("leaveRoom").disabled = false;
                document.getElementById("roomId").disabled = true;
                
                // æˆ¿ä¸»è‡ªå·±åŠ å…¥ç©å®¶åˆ—è¡¨
                gameState.players = [{
                    id: id, 
                    name: myName, 
                    avatar: myAvatar, 
                    isHost: true, 
                    hand: [], 
                    isEliminated: false, 
                    isProtected: false
                }];
                
                updateUI();
                
                // ç›£è½å…¶ä»–ç©å®¶çš„é€£ç·š
                peer.on('connection', (connection) => {
                    logSystem(`ç©å®¶æ­£åœ¨é€£ç·š: ${connection.peer}`);
                    hostConnections.push(connection);
                    
                    connection.on('open', () => {
                        logSystem(`ç©å®¶é€£ç·šæˆåŠŸ: ${connection.peer}`);
                    });
                    
                    connection.on('data', (data) => {
                        handleHostData(data, connection);
                    });
                    
                    connection.on('close', () => {
                        handlePlayerDisconnect(connection.peer);
                    });

                    connection.on('error', (err) => {
                        console.log('é€£ç·šéŒ¯èª¤:', err);
                    });
                });
            });
            
            peer.on('error', (err) => {
                console.error("PeerJSéŒ¯èª¤:", err);
                alert("å‰µå»ºæˆ¿é–“å¤±æ•—: " + err.type);
                handleLeaveRoom();
            });
        }

        function joinRoom() {
            myName = document.getElementById("playerName").value || "ç©å®¶";
            hostPeerId = document.getElementById("roomId").value.trim();
            
            if(!hostPeerId) { 
                alert("è«‹è¼¸å…¥æˆ¿ä¸»çš„æˆ¿é–“IDï¼"); 
                return; 
            }
            
            document.getElementById("createRoom").disabled = true;
            document.getElementById("joinRoom").disabled = true;
            document.getElementById("playerName").disabled = true;
            document.getElementById("roomId").disabled = true;
            
            // å‰µå»º Peer å°è±¡ï¼Œä¸å¸¶åƒæ•¸è®“ PeerJS è‡ªå‹•ç”Ÿæˆå”¯ä¸€ ID
            peer = new Peer(null, PEER_CONFIG);
            
            peer.on('open', (id) => {
                // æˆåŠŸå‰µå»º Peerï¼Œç¾åœ¨å˜—è©¦é€£æ¥åˆ°æˆ¿ä¸»
                isHost = false;
                myPlayerId = id;
                currentRoomId = hostPeerId;
                
                logSystem(`æ­£åœ¨é€£ç·šåˆ°æˆ¿é–“: ${hostPeerId}`);
                
                // å˜—è©¦é€£æ¥åˆ°æˆ¿ä¸»
                conn = peer.connect(hostPeerId, { reliable: true });
                
                conn.on('open', () => {
                    logSystem(`å·²æˆåŠŸé€£ç·šåˆ°æˆ¿ä¸»ï¼`);
                    
                    document.getElementById("leaveRoom").disabled = false;
                    document.getElementById("startGame").style.display = "none";
                    
                    // ç™¼é€åŠ å…¥è¨Šæ¯
                    conn.send({
                        type: "JOIN",
                        player: { 
                            id: myPlayerId, 
                            name: myName, 
                            avatar: myAvatar,
                            isHost: false
                        }
                    });
                });
                
                conn.on('data', (data) => {
                    handleClientData(data);
                });
                
                conn.on('close', () => {
                    alert("èˆ‡æˆ¿ä¸»çš„é€£ç·šå·²ä¸­æ–·");
                    handleLeaveRoom();
                });
                
                conn.on('error', (err) => {
                    console.error("é€£ç·šéŒ¯èª¤:", err);
                    alert("é€£ç·šå¤±æ•—: " + err);
                    handleLeaveRoom();
                });
            });
            
            peer.on('error', (err) => {
                console.error("PeerJSéŒ¯èª¤:", err);
                alert("é€£ç·šéŒ¯èª¤: " + err.type);
                handleLeaveRoom();
            });
        }

        function handlePlayerDisconnect(playerId) {
            const playerIndex = gameState.players.findIndex(p => p.id === playerId);
            if (playerIndex !== -1) {
                const playerName = gameState.players[playerIndex].name;
                logSystem(`ç©å®¶ ${playerName} å·²é›¢ç·š`);
                
                if (gameState.phase === "waiting") {
                    gameState.players.splice(playerIndex, 1);
                    broadcastState();
                }
                else if (gameState.phase === "playing") {
                    gameState.players[playerIndex].isEliminated = true;
                    broadcastState();
                }
            }
            
            hostConnections = hostConnections.filter(c => c.peer !== playerId);
        }

        // --- 5. è³‡æ–™è™•ç† ---
        function sendData(data) {
            if (isHost) {
                handleHostData(data, null); 
            } else if (conn && conn.open) {
                conn.send(data);
            }
        }
        
        function broadcastState() {
            if (!isHost) return;
            const data = { type: "SYNC_STATE", state: gameState };
            hostConnections.forEach(c => {
                if(c.open) c.send(data);
            });
            updateUI(); 
        }
        
        // Host è™•ç†é‚è¼¯
        function handleHostData(data, senderConn) {
            switch(data.type) {
                case "JOIN":
                    logSystem(`ç©å®¶ ${data.player.name} åŠ å…¥äº†æˆ¿é–“`);
                    
                    // æª¢æŸ¥æ˜¯å¦å·²æœ‰ç›¸åŒç©å®¶
                    const existingPlayer = gameState.players.find(p => p.id === data.player.id);
                    
                    if (!existingPlayer) {
                        // æ–°ç©å®¶åŠ å…¥
                        const newPlayer = {
                            ...data.player,
                            hand: [], 
                            isEliminated: false, 
                            isProtected: false
                        };
                        
                        gameState.players.push(newPlayer);
                        
                        // å‘æ–°ç©å®¶ç™¼é€æ­¡è¿è¨Šæ¯å’Œç•¶å‰ç‹€æ…‹
                        if (senderConn) {
                            senderConn.send({
                                type: "WELCOME",
                                playerId: data.player.id,
                                state: gameState
                            });
                        }
                        
                        // å»£æ’­çµ¦æ‰€æœ‰ç©å®¶
                        broadcastState();
                    } else {
                        // ç©å®¶å·²å­˜åœ¨ï¼Œå¯èƒ½æ˜¯é‡æ–°é€£ç·š
                        if (senderConn) {
                            senderConn.send({
                                type: "WELCOME",
                                playerId: data.player.id,
                                state: gameState
                            });
                        }
                    }
                    break;
                    
                case "UPDATE_PROFILE":
                    const p = gameState.players.find(p => p.id === (senderConn ? senderConn.peer : myPlayerId));
                    if(p) {
                        p.name = data.name;
                        p.avatar = data.avatar;
                        broadcastState();
                    }
                    break;
                    
                case "ACTION_PLAY_CARD":
                    processCardEffect(data.playerId, data.card, data.targetId, data.guessValue);
                    break;
                    
                case "ACTION_DRAW":
                    hostHandleDraw(data.playerId);
                    break;
            }
        }

        // Client è™•ç†é‚è¼¯
        function handleClientData(data) {
            switch(data.type) {
                case "WELCOME":
                    // æ›´æ–°è‡ªå·±çš„IDï¼ˆå¦‚æœéœ€è¦ï¼‰
                    if (data.playerId !== myPlayerId) {
                        myPlayerId = data.playerId;
                    }
                    // æ›´æ–°éŠæˆ²ç‹€æ…‹
                    gameState = data.state;
                    updateUI();
                    break;
                    
                case "SYNC_STATE":
                    gameState = data.state;
                    updateUI();
                    break;
                    
                case "LOG":
                    logRaw(data.message, data.style);
                    break;
            }
        }

        // --- 6. éŠæˆ²æ ¸å¿ƒé‚è¼¯ ---
        function tryStartGame() {
            if(gameState.players.length < 2) {
                alert("è‡³å°‘éœ€è¦2åç©å®¶æ‰èƒ½é–‹å§‹éŠæˆ²ï¼");
                return;
            }
            
            if(gameState.players.length > 5) {
                alert("æœ€å¤šåªèƒ½5åç©å®¶ï¼");
                return;
            }
            
            // åˆå§‹åŒ–ç‰Œå †ï¼ˆ25å¼µç‰Œï¼‰
            let deck = [];
            for(let val in CARDS) {
                const card = CARDS[val];
                for(let i = 0; i < card.count; i++) {
                    deck.push({ 
                        value: parseFloat(val), 
                        uid: Math.random().toString(36).substr(2, 9),
                        gender: card.gender
                    });
                }
            }
            
            // æ´—ç‰Œ
            for(let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
            
            // ç§»é™¤ä¸€å¼µç‰Œ (æš—ç‰Œ)
            const removed = deck.pop();
            
            gameState.deck = deck;
            gameState.discardPile = [];
            gameState.players.forEach(p => {
                p.hand = [deck.pop()];
                p.isEliminated = false;
                p.isProtected = false;
            });
            
            gameState.currentPlayerIndex = Math.floor(Math.random() * gameState.players.length);
            gameState.phase = "playing";
            
            logSystem("éŠæˆ²é–‹å§‹ï¼");
            logImportant(`åˆå§‹ç§»é™¤äº†ä¸€å¼µç‰Œã€‚ç‰Œåº«å‰©é¤˜: ${deck.length}å¼µ`);
            
            broadcastState();
        }

        function hostHandleDraw(playerId) {
            const player = gameState.players.find(p => p.id === playerId);
            if (!player) return;
            
            if(player.hand.length >= 2) {
                logSystem(`${player.name} å·²ç¶“æœ‰2å¼µæ‰‹ç‰Œäº†`);
                return;
            }
            
            if(gameState.deck.length > 0) {
                player.hand.push(gameState.deck.pop());
                logPlayer(player.name, "æŠ½äº†ä¸€å¼µç‰Œ");
                broadcastState();
            } else {
                // ç‰Œåº«å·²ç©ºï¼ŒéŠæˆ²çµæŸ
                endGameComparison();
            }
        }

        function processCardEffect(playerId, card, targetId, guessValue) {
            const player = gameState.players.find(p => p.id === playerId);
            const target = targetId ? gameState.players.find(p => p.id === targetId) : null;
            
            if (!player) return;
            
            // 1. ç§»é™¤æ‰‹ç‰Œä¸¦åŠ å…¥æ£„ç‰Œå †
            player.hand = player.hand.filter(c => c.uid !== card.uid);
            gameState.discardPile.push({card: card, playedBy: player.name});
            
            logPlayer(player.name, `æ‰“å‡ºäº† ã€${CARDS[card.value].name}ã€‘`);
            
            // è§£é™¤ä¿è­·ç‹€æ…‹
            player.isProtected = false;
            
            // 2. åŸ·è¡Œå¡ç‰‡æ•ˆæœ
            let eliminatedName = null;
            
            switch(card.value) {
                case 1: // åˆºå®¢
                    logSystem(`${player.name} çš„åˆºå®¢å·²æ‰“å‡ºï¼Œè¢«å‹•æ•ˆæœå·²å•Ÿç”¨`);
                    break;
                    
                case 2: // è¡›å…µ
                case 2.5: // å…µé•·
                    if(target && !target.isProtected && target.hand.length > 0) {
                        const targetCard = target.hand[0];
                        if(targetCard.value == guessValue) {
                            eliminatedName = target.name;
                            target.isEliminated = true;
                            logImportant(`${player.name} çŒœå°äº†ï¼ ${target.name} æ‰‹ç‰Œæ˜¯ ${CARDS[targetCard.value].name}ï¼Œé­åˆ°æ·˜æ±°ï¼`);
                        } else {
                            logSystem(`${player.name} çŒœéŒ¯äº†ã€‚`);
                            // åˆºå®¢åæ®ºé‚è¼¯
                            if(targetCard.value === 1) {
                                player.isEliminated = true;
                                logImportant(`${target.name} æ‰‹æŒåˆºå®¢ï¼ ${player.name} åè¢«æ·˜æ±°ï¼`);
                            }
                        }
                    }
                    break;
                    
                case 3: // ç¥çˆ¶
                    if(target && !target.isProtected && target.hand.length > 0) {
                        logSystem(`${player.name} æŸ¥çœ‹äº† ${target.name} çš„æ‰‹ç‰Œã€‚`);
                        sendPrivateMessage(player.id, `ä½ çœ‹åˆ° ${target.name} çš„æ‰‹ç‰Œæ˜¯ï¼š${CARDS[target.hand[0].value].name}`);
                    }
                    break;
                    
                case 3.5: // é‚±æ¯”ç‰¹
                    if(target && !target.isProtected && player.hand.length > 0 && target.hand.length > 0) {
                        const pCard = player.hand[0];
                        const tCard = target.hand[0];
                        
                        logSystem(`é‚±æ¯”ç‰¹æ¯”å¤§å°ï¼š${player.name} (${CARDS[pCard.value].name}) vs ${target.name} (${CARDS[tCard.value].name})`);
                        
                        // å…¬ä¸»å¿…å‹
                        if(pCard.value === 9) { 
                            target.isEliminated = true; 
                            eliminatedName = target.name; 
                        }
                        else if(tCard.value === 9) { 
                            player.isEliminated = true; 
                            eliminatedName = player.name; 
                        }
                        else if (pCard.gender === tCard.gender) {
                            // åŒæ€§ï¼šæ•¸å­—å°çš„å‡ºå±€
                            if(pCard.value < tCard.value) {
                                player.isEliminated = true;
                                eliminatedName = player.name;
                            } else if(tCard.value < pCard.value) {
                                target.isEliminated = true;
                                eliminatedName = target.name;
                            } else {
                                logSystem("å¹³æ‰‹ï¼ç„¡äººå‡ºå±€ã€‚");
                            }
                        } else {
                            // ç•°æ€§ï¼šæ•¸å­—å¤§çš„å‡ºå±€
                            if(pCard.value > tCard.value) {
                                player.isEliminated = true;
                                eliminatedName = player.name;
                            } else if(tCard.value > pCard.value) {
                                target.isEliminated = true;
                                eliminatedName = target.name;
                            } else {
                                logSystem("å¹³æ‰‹ï¼ç„¡äººå‡ºå±€ã€‚");
                            }
                        }
                        
                        if(eliminatedName) {
                            logImportant(`${eliminatedName} é‚±æ¯”ç‰¹æ¯”å¤§å°å‡ºå±€ï¼`);
                        }
                    }
                    break;
                    
                case 4: // ç”·çˆµ
                    if(target && !target.isProtected && player.hand.length > 0 && target.hand.length > 0) {
                        const pCard = player.hand[0];
                        const tCard = target.hand[0];
                        
                        logSystem(`ç”·çˆµæ¯”å¤§å°ï¼š${player.name} vs ${target.name}`);
                        
                        // å…¬ä¸»å¿…å‹
                        if(pCard.value === 9) { 
                            target.isEliminated = true; 
                            eliminatedName = target.name; 
                        }
                        else if(tCard.value === 9) { 
                            player.isEliminated = true; 
                            eliminatedName = player.name; 
                        }
                        else if (pCard.value > tCard.value) { 
                            target.isEliminated = true; 
                            eliminatedName = target.name; 
                        }
                        else if (tCard.value > pCard.value) { 
                            player.isEliminated = true; 
                            eliminatedName = player.name; 
                        }
                        else { 
                            logSystem("å¹³æ‰‹ï¼ç„¡äººå‡ºå±€ã€‚"); 
                        }
                        
                        if(eliminatedName) {
                            logImportant(`${eliminatedName} æ¯”å¤§å°è¼¸äº†ï¼Œé­åˆ°æ·˜æ±°ï¼`);
                        }
                    }
                    break;
                    
                case 4.5: // é è¨€å®¶
                    logSystem(`${player.name} ä½¿ç”¨äº†é è¨€å®¶ï¼Œä½†æ•ˆæœæš«æœªå¯¦ä½œ`);
                    break;
                    
                case 5: // ä¾å¥³
                    player.isProtected = true;
                    logSystem(`${player.name} ç²å¾—äº†ä¿è­·ï¼Œç›´åˆ°ä¸‹å›åˆã€‚`);
                    break;
                    
                case 5.5: // å°ä¸‘
                    if(gameState.discardPile.length > 1) {
                        const lastPlayed = gameState.discardPile[gameState.discardPile.length - 2];
                        logSystem(`${player.name} è¤‡è£½äº†ä¸Šä¸€å¼µç‰Œï¼š${CARDS[lastPlayed.card.value].name}`);
                    } else {
                        logSystem(`${player.name} ä½¿ç”¨äº†å°ä¸‘ï¼Œä½†å ´ä¸Šç„¡ç‰Œå¯è¤‡è£½`);
                    }
                    break;
                    
                case 6: // ç‹å­
                    if(target && !target.isProtected && target.hand.length > 0) {
                        const discarded = target.hand.pop();
                        gameState.discardPile.push({card: discarded, playedBy: target.name + "(æ£„)"});
                        logSystem(`${target.name} æ£„æ‰äº† ${CARDS[discarded.value].name}`);
                        
                        if(discarded.value === 9) {
                            target.isEliminated = true;
                            logImportant(`${target.name} æ£„æ‰äº†å…¬ä¸»ï¼Œç›´æ¥æ·˜æ±°ï¼`);
                        } else {
                            // æŠ½æ–°ç‰Œ
                            if(gameState.deck.length > 0) {
                                target.hand.push(gameState.deck.pop());
                            }
                        }
                    }
                    break;
                    
                case 7: // åœ‹ç‹
                    if(target && !target.isProtected && player.hand.length > 0 && target.hand.length > 0) {
                        [player.hand[0], target.hand[0]] = [target.hand[0], player.hand[0]];
                        logSystem(`${player.name} èˆ‡ ${target.name} äº¤æ›äº†æ‰‹ç‰Œï¼`);
                    }
                    break;
                    
                case 8: // ä¼¯çˆµå¤«äºº
                    logSystem(`${player.name} æ‰“å‡ºäº†ä¼¯çˆµå¤«äºº`);
                    break;
                    
                case 9: // å…¬ä¸»
                    player.isEliminated = true;
                    logImportant(`${player.name} æ‰“å‡ºäº†å…¬ä¸»ï¼Œç›´æ¥æ·˜æ±°ï¼`);
                    break;
            }
            
            // 3. æª¢æŸ¥éŠæˆ²æ˜¯å¦çµæŸ
            const activePlayers = gameState.players.filter(p => !p.isEliminated);
            if(activePlayers.length === 1) {
                endGame(activePlayers[0]);
                return;
            }
            
            // 4. åˆ‡æ›åˆ°ä¸‹ä¸€ä½ç©å®¶
            nextTurn();
        }

        function nextTurn() {
            if (gameState.players.length === 0) return;
            
            let nextIndex = (gameState.currentPlayerIndex + 1) % gameState.players.length;
            let loopCount = 0;
            
            // æ‰¾ä¸‹ä¸€å€‹æœªæ·˜æ±°çš„ç©å®¶
            while(gameState.players[nextIndex].isEliminated && loopCount < gameState.players.length) {
                nextIndex = (nextIndex + 1) % gameState.players.length;
                loopCount++;
            }
            
            if(gameState.deck.length === 0) {
                endGameComparison();
            } else {
                gameState.currentPlayerIndex = nextIndex;
                broadcastState();
            }
        }

        function endGameComparison() {
            let maxVal = -1;
            let winners = [];
            
            gameState.players.forEach(p => {
                if(!p.isEliminated && p.hand.length > 0) {
                    const val = p.hand[0].value;
                    if(val > maxVal) {
                        maxVal = val;
                        winners = [p];
                    } else if (val === maxVal) {
                        winners.push(p);
                    }
                }
            });
            
            if(winners.length === 1) {
                endGame(winners[0]);
            } else if (winners.length > 1) {
                const winnerNames = winners.map(w => w.name).join(", ");
                logImportant(`éŠæˆ²çµæŸï¼å¹³æ‰‹ï¼ç²å‹è€…: ${winnerNames} (é»æ•¸ç›¸åŒ: ${maxVal})`);
                gameState.phase = "ended";
                broadcastState();
            } else {
                logImportant("éŠæˆ²çµæŸï¼æ²’æœ‰è´å®¶ï¼Ÿ");
                gameState.phase = "ended";
                broadcastState();
            }
        }

        function endGame(winner) {
            gameState.phase = "ended";
            if(winner) {
                logImportant(`ğŸ† éŠæˆ²çµæŸï¼ç²å‹è€…æ˜¯ï¼š${winner.name}ï¼`);
            }
            broadcastState();
        }

        function sendPrivateMessage(targetId, msg) {
            if (isHost) {
                if (targetId === myPlayerId) {
                    logImportant(msg);
                } else {
                    const conn = hostConnections.find(c => c.peer === targetId);
                    if (conn) {
                        conn.send({
                            type: "LOG", 
                            message: msg, 
                            style: "important"
                        });
                    }
                }
            }
        }

        // --- 7. UI æ›´æ–°é‚è¼¯ ---
        function updateUI() {
            document.getElementById("deckCount").textContent = gameState.deck.length;
            
            if (gameState.phase === "waiting") {
                document.getElementById("roomSection").style.display = "block";
                document.getElementById("gameSection").style.display = "none";
                document.getElementById("waitingRoomArea").style.display = "block";
                
                if (isHost) {
                    document.getElementById("startGame").disabled = gameState.players.length < 2;
                }
            } else {
                document.getElementById("roomSection").style.display = "none";
                document.getElementById("gameSection").style.display = "block";
                document.getElementById("waitingRoomArea").style.display = "none";
            }
            
            updatePlayersList();
            updateHand();
            updateControls();
        }

        function updatePlayersList() {
            const container = document.getElementById("playersContainer");
            container.innerHTML = "";
            
            if (gameState.players.length === 0) {
                container.innerHTML = `
                    <div class="text-center" style="grid-column: 1 / -1; padding: 20px; color: var(--light-gold);">
                        ç­‰å¾…ç©å®¶åŠ å…¥æˆ¿é–“...
                    </div>
                `;
                return;
            }
            
            gameState.players.forEach((p, index) => {
                const isCurrent = (gameState.phase === "playing" && index === gameState.currentPlayerIndex);
                const isMe = p.id === myPlayerId;
                
                const cardDiv = document.createElement("div");
                cardDiv.className = `player-card ${p.isHost ? 'host' : ''} ${isCurrent ? 'current-turn' : ''} ${p.isEliminated ? 'eliminated' : ''}`;
                
                let statusText = p.isEliminated ? '<span style="color:red">(å‡ºå±€)</span>' : 
                                (p.isProtected ? '<span style="color:lightblue">(å—ä¿è­·)</span>' : '');
                
                if(isCurrent && gameState.phase === "playing") {
                    statusText += ' <span style="color:gold; font-weight:bold;">(ç•¶å‰å›åˆ)</span>';
                }
                
                cardDiv.innerHTML = `
                    <div class="player-avatar">${p.avatar}</div>
                    <div class="player-info">
                        <div class="player-name">
                            ${p.name} ${isMe ? '<span style="color:var(--green)">(ä½ )</span>' : ''}
                        </div>
                        <div class="player-status">${statusText}</div>
                    </div>
                `;
                container.appendChild(cardDiv);
                
                if(isCurrent) {
                    document.getElementById("currentPlayerName").textContent = p.name;
                }
            });
        }

        function updateHand() {
            const handContainer = document.getElementById("handContainer");
            handContainer.innerHTML = "";
            
            const myData = gameState.players.find(p => p.id === myPlayerId);
            if(!myData) return;
            
            if(myData.isEliminated) {
                handContainer.innerHTML = `<div style="color:var(--red); font-size:1.5rem; text-align:center; width:100%;">ä½ å·²å‡ºå±€ ğŸ‘»</div>`;
                return;
            }
            
            if(gameState.phase !== "playing") {
                handContainer.innerHTML = `<div style="color:var(--light-gold); font-size:1.2rem; text-align:center; width:100%;">ç­‰å¾…éŠæˆ²é–‹å§‹...</div>`;
                return;
            }
            
            myData.hand.forEach((card, index) => {
                const el = document.createElement("div");
                el.className = `card ${index === selectedHandIndex ? 'selected' : ''}`;
                const cardInfo = CARDS[card.value];
                const genderIcon = cardInfo.gender === "male" ? "â™‚" : "â™€";
                const genderClass = cardInfo.gender === "male" ? "male" : "female";
                
                el.innerHTML = `
                    <div class="card-number">${card.value}</div>
                    <div class="card-gender ${genderClass}">${genderIcon}</div>
                    <div class="card-name">${cardInfo.name}</div>
                    <div class="card-effect">${cardInfo.effect}</div>
                `;
                
                el.onclick = () => {
                    if(!isMyTurn() || !hasDrawnCard()) return;
                    
                    // æª¢æŸ¥ä¼¯çˆµå¤«äººè¦å‰‡
                    const handValues = myData.hand.map(c => c.value);
                    if((handValues.includes(7) || handValues.includes(6)) && card.value !== 8 && handValues.includes(8)) {
                        alert("ä½ æœ‰åœ‹ç‹æˆ–ç‹å­ï¼Œå¿…é ˆæ‰“å‡ºä¼¯çˆµå¤«äººï¼");
                        return;
                    }
                    
                    selectedHandIndex = index;
                    updateHand();
                    updateControls();
                };
                
                handContainer.appendChild(el);
            });
            
            // å¦‚æœæ‰‹ç‰Œå°‘æ–¼2å¼µä¸”ä¸æ˜¯è‡ªå·±çš„å›åˆï¼Œé¡¯ç¤ºç‰ŒèƒŒ
            if(myData.hand.length < 2 && !isMyTurn()) {
                for(let i = myData.hand.length; i < 2; i++) {
                    const el = document.createElement("div");
                    el.className = "card card-back";
                    el.innerHTML = `
                        <div class="card-name">ç‰ŒèƒŒ</div>
                        <i class="fas fa-question"></i>
                    `;
                    handContainer.appendChild(el);
                }
            }
        }

        function updateControls() {
            const myTurn = isMyTurn();
            const drawn = hasDrawnCard();
            
            const btnDraw = document.getElementById("drawCard");
            const btnPlay = document.getElementById("playCard");
            const txt = document.getElementById("turnInstruction");
            
            if(gameState.phase !== "playing") {
                btnDraw.disabled = true;
                btnPlay.disabled = true;
                return;
            }
            
            if(myTurn) {
                if(!drawn) {
                    btnDraw.disabled = false;
                    btnPlay.disabled = true;
                    txt.textContent = "è¼ªåˆ°ä½ äº†ï¼Œè«‹æŠ½ä¸€å¼µç‰Œï¼";
                } else {
                    btnDraw.disabled = true;
                    btnPlay.disabled = selectedHandIndex === -1;
                    txt.textContent = selectedHandIndex === -1 ? "è«‹é¸æ“‡ä¸€å¼µæ‰‹ç‰Œæ‰“å‡º" : "é»æ“Šæ‰“å‡ºæŒ‰éˆ•ä¾†å‡ºç‰Œ";
                }
            } else {
                btnDraw.disabled = true;
                btnPlay.disabled = true;
                const currentPlayer = gameState.players[gameState.currentPlayerIndex];
                txt.textContent = currentPlayer ? `ç­‰å¾… ${currentPlayer.name} è¡Œå‹•...` : "ç­‰å¾…å…¶ä»–ç©å®¶...";
            }
        }

        function isMyTurn() {
            if(gameState.phase !== "playing") return false;
            const currentP = gameState.players[gameState.currentPlayerIndex];
            return currentP && currentP.id === myPlayerId;
        }

        function hasDrawnCard() {
            const myData = gameState.players.find(p => p.id === myPlayerId);
            return myData && myData.hand.length === 2;
        }

        // --- 8. ç©å®¶å‹•ä½œ ---
        function actionDrawCard() {
            sendData({ type: "ACTION_DRAW", playerId: myPlayerId });
        }

        function preparePlayCard() {
            if(selectedHandIndex === -1) {
                alert("è«‹å…ˆé¸æ“‡ä¸€å¼µæ‰‹ç‰Œï¼");
                return;
            }
            
            const myData = gameState.players.find(p => p.id === myPlayerId);
            if(!myData || myData.hand.length <= selectedHandIndex) return;
            
            const card = myData.hand[selectedHandIndex];
            const val = card.value;
            
            // éœ€è¦æŒ‡å®šå°è±¡çš„ç‰Œ
            const needTarget = [2, 2.5, 3, 3.5, 4, 6, 7].includes(val);
            
            if(needTarget) {
                showTargetSelection(val);
            } else {
                confirmPlayCard(card, null, null);
            }
        }

        function showTargetSelection(cardValue) {
            const container = document.getElementById("selectablePlayers");
            container.innerHTML = "";
            document.getElementById("playerSelection").style.display = "block";
            
            gameState.players.forEach(p => {
                if(!p.isEliminated) {
                    const btn = document.createElement("button");
                    btn.className = "card-target-btn";
                    btn.innerHTML = p.id === myPlayerId ? `${p.name} (è‡ªå·±)` : p.name;
                    
                    // è¦å‰‡æª¢æŸ¥
                    if(cardValue !== 6 && p.id === myPlayerId) {
                        btn.disabled = true;
                        btn.style.opacity = "0.5";
                    }
                    
                    if(p.isProtected && cardValue !== 6 && p.id !== myPlayerId) {
                        btn.disabled = true;
                        btn.innerHTML += " (å—ä¿è­·)";
                    }
                    
                    btn.onclick = () => {
                        tempTargetPlayerId = p.id;
                        document.getElementById("playerSelection").style.display = "none";
                        
                        // è¡›å…µéœ€è¦çŒœç‰Œ
                        if(cardValue === 2 || cardValue === 2.5) {
                            showGuessSelection(p.name);
                        } else {
                            const myData = gameState.players.find(tp => tp.id === myPlayerId);
                            confirmPlayCard(myData.hand[selectedHandIndex], tempTargetPlayerId, null);
                        }
                    };
                    container.appendChild(btn);
                }
            });
        }

        function showGuessSelection(targetName) {
            document.getElementById("guessTargetName").textContent = targetName;
            const container = document.getElementById("guessOptions");
            container.innerHTML = "";
            document.getElementById("guessSelection").style.display = "block";
            
            // ç”¢ç”ŸçŒœç‰Œé¸é …ï¼ˆé™¤äº†è¡›å…µï¼‰
            for(let key in CARDS) {
                const val = parseFloat(key);
                if(val !== 2 && val !== 2.5) {
                    const btn = document.createElement("button");
                    btn.className = "card-target-btn";
                    btn.textContent = `${val} ${CARDS[key].name}`;
                    btn.onclick = () => {
                        document.getElementById("guessSelection").style.display = "none";
                        const myData = gameState.players.find(tp => tp.id === myPlayerId);
                        confirmPlayCard(myData.hand[selectedHandIndex], tempTargetPlayerId, val);
                    };
                    container.appendChild(btn);
                }
            }
        }

        function resetSelectionUI() {
            document.getElementById("playerSelection").style.display = "none";
            document.getElementById("guessSelection").style.display = "none";
        }

        function confirmPlayCard(card, targetId, guessVal) {
            sendData({
                type: "ACTION_PLAY_CARD",
                playerId: myPlayerId,
                card: card,
                targetId: targetId,
                guessValue: guessVal
            });
            
            selectedHandIndex = -1;
            tempTargetPlayerId = null;
            resetSelectionUI();
        }

        function handleLeaveRoom() {
            if(confirm("ç¢ºå®šè¦é›¢é–‹æˆ¿é–“å—ï¼Ÿ")) {
                if(peer) peer.destroy();
                location.reload();
            }
        }

        function updateAndShowHint() {
            const tbody = document.getElementById("cardsTableBody");
            tbody.innerHTML = "";
            
            // è¨ˆç®—å·²å‡ºéçš„ç‰Œ (æ£„ç‰Œå †)
            let playedCounts = {};
            gameState.discardPile.forEach(item => {
                const v = item.card.value;
                playedCounts[v] = (playedCounts[v] || 0) + 1;
            });
            
            // å»ºç«‹è¡¨æ ¼
            for(let key in CARDS) {
                const card = CARDS[key];
                const played = playedCounts[key] || 0;
                const remaining = Math.max(0, card.count - played);
                
                const tr = document.createElement("tr");
                if(remaining <= 0) tr.style.opacity = "0.5";
                
                tr.innerHTML = `
                    <td><span class="count-badge">${key}</span></td>
                    <td style="font-weight:bold;">${card.name}</td>
                    <td>${card.count}</td>
                    <td style="color:${remaining > 0 ? 'var(--green)' : 'var(--red)'}; font-weight:bold;">${remaining}</td>
                    <td style="text-align:left; font-size:0.85rem;">${card.effect}</td>
                `;
                tbody.appendChild(tr);
            }
            
            document.getElementById("hintModal").style.display = "flex";
        }
        
        function copyRoomId() {
            const roomIdBox = document.getElementById("roomIdBox");
            const text = roomIdBox.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                const originalText = document.getElementById("copyRoomId").innerHTML;
                document.getElementById("copyRoomId").innerHTML = '<i class="fas fa-check"></i> å·²è¤‡è£½';
                document.getElementById("copyRoomId").style.backgroundColor = "var(--green)";
                
                setTimeout(() => {
                    document.getElementById("copyRoomId").innerHTML = originalText;
                    document.getElementById("copyRoomId").style.backgroundColor = "";
                }, 2000);
            }).catch(err => {
                console.error('è¤‡è£½å¤±æ•—:', err);
                alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½æ–‡å­—');
            });
        }

        // --- è¼”åŠ©åŠŸèƒ½ ---
        function logSystem(msg) {
            logRaw(msg, "system");
            if(isHost) {
                hostConnections.forEach(c => {
                    if(c.open) c.send({
                        type: "LOG", 
                        message: msg, 
                        style: "system"
                    });
                });
            }
        }

        function logPlayer(name, action) {
            const msg = `${name} ${action}`;
            logRaw(msg, "player-action");
            if(isHost) {
                hostConnections.forEach(c => {
                    if(c.open) c.send({
                        type: "LOG", 
                        message: msg, 
                        style: "player-action"
                    });
                });
            }
        }

        function logImportant(msg) {
            logRaw(msg, "important");
            if(isHost) {
                hostConnections.forEach(c => {
                    if(c.open) c.send({
                        type: "LOG", 
                        message: msg, 
                        style: "important"
                    });
                });
            }
        }

        function logRaw(msg, style) {
            const logDiv = document.getElementById("gameLog");
            const entry = document.createElement("div");
            entry.className = `log-entry ${style}`;
            const time = new Date().toLocaleTimeString('zh-TW', {hour12: false, hour:'2-digit', minute:'2-digit', second:'2-digit'});
            entry.innerHTML = `<span style="font-size:0.8rem; opacity:0.7">[${time}]</span> ${msg}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function playDiceGame() {
            const d1 = Math.floor(Math.random() * 6) + 1;
            const d2 = Math.floor(Math.random() * 6) + 1;
            document.getElementById("dice1").textContent = d1;
            document.getElementById("dice2").textContent = d2;
            const sum = d1 + d2;
            let resultText = "";
            if(d1 === d2) resultText = "è±¹å­ï¼é‹æ°£ä¸éŒ¯å–”ï¼";
            else if(sum > 9) resultText = "å¤§é»æ•¸ï¼";
            else resultText = "é»æ•¸ä¸€èˆ¬èˆ¬...";
            document.getElementById("diceResult").textContent = `ç¸½å’Œ: ${sum} - ${resultText}`;
        }
    </script>
</body>
</html>
