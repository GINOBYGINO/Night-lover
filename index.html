<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã€æƒ…æ›¸ã€‘v0.5 - ä¿®æ­£ç‰ˆ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root {
            --dark-brown: #2c1b0f;
            --medium-brown: #4a3728;
            --light-brown: #7a5c3c;
            --gold: #d4af37;
            --light-gold: #f4e4b5;
            --dark-gold: #b8941f;
            --red: #8b0000;
            --green: #006400;
            --text-light: #f5deb3;
            --text-dark: #3d2c1e;
            --card-bg: #f8f1e5;
            --shadow: rgba(0, 0, 0, 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(to bottom, var(--dark-brown), var(--medium-brown));
            color: var(--text-light);
            min-height: 100vh;
            padding: 10px;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* æ¨™é¡Œå€åŸŸ */
        header {
            text-align: center;
            padding: 15px;
            border-bottom: 2px solid var(--gold);
            margin-bottom: 20px;
            background-color: rgba(44, 27, 15, 0.8);
            border-radius: 10px;
            box-shadow: 0 5px 15px var(--shadow);
        }

        h1 {
            color: var(--gold);
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px var(--shadow);
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.2rem;
            color: var(--light-gold);
            margin-bottom: 15px;
        }

        /* ä¸»éŠæˆ²å€åŸŸ */
        .game-area {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* æˆ¿é–“å€åŸŸ */
        .room-section {
            background-color: rgba(74, 55, 40, 0.9);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px var(--shadow);
            border: 1px solid var(--light-brown);
        }

        .room-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            min-width: 200px;
        }

        label {
            margin-bottom: 5px;
            color: var(--light-gold);
            font-weight: bold;
        }

        input, select, button {
            padding: 12px 15px;
            border-radius: 5px;
            border: 1px solid var(--light-brown);
            font-size: 1rem;
        }

        input, select {
            background-color: var(--card-bg);
            color: var(--text-dark);
        }

        button {
            background-color: var(--gold);
            color: var(--dark-brown);
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        button:hover:not(:disabled) {
            background-color: var(--light-gold);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            filter: grayscale(1);
        }

        .danger-btn {
            background-color: var(--red);
            color: white;
        }

        .success-btn {
            background-color: var(--green);
            color: white;
        }

        /* ç©å®¶åˆ—è¡¨ */
        .players-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .player-card {
            background-color: rgba(122, 92, 60, 0.7);
            border-radius: 8px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            border: 3px solid transparent;
            transition: all 0.3s;
            position: relative;
        }

        .player-card.host {
            border-color: var(--light-gold);
        }
        
        .player-card.host::after {
            content: 'ğŸ‘‘';
            position: absolute;
            top: -10px;
            right: -5px;
            font-size: 1.5rem;
        }

        /* (4) å›åˆåˆ‡æ›å„ªåŒ–ï¼šç™¼å…‰èˆ‡è„ˆè¡ */
        .player-card.current-turn {
            border-color: var(--gold);
            box-shadow: 0 0 20px var(--gold), inset 0 0 10px var(--gold);
            background-color: rgba(184, 148, 31, 0.4);
            animation: pulse-border 1.5s infinite;
            z-index: 10;
        }

        .player-card.eliminated {
            opacity: 0.6;
            filter: grayscale(0.8);
            border-color: var(--red);
            background-color: rgba(50, 0, 0, 0.5);
        }

        .player-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            background-color: var(--dark-brown);
            border: 2px solid var(--light-brown);
        }

        .player-info {
            flex-grow: 1;
        }

        .player-name {
            font-weight: bold;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .player-status {
            font-size: 0.9rem;
            color: var(--light-gold);
        }
        
        .turn-badge {
            display: none;
            background-color: var(--gold);
            color: var(--dark-brown);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            margin-left: auto;
            font-weight: bold;
        }
        
        .player-card.current-turn .turn-badge {
            display: inline-block;
        }

        /* éŠæˆ²å€åŸŸ */
        .game-section {
            display: none;
            background-color: rgba(74, 55, 40, 0.9);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px var(--shadow);
            border: 1px solid var(--light-brown);
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--light-brown);
        }

        .game-info {
            display: flex;
            gap: 20px;
            font-size: 1.1rem;
        }

        .deck-info, .turn-info {
            background-color: rgba(44, 27, 15, 0.7);
            padding: 10px 15px;
            border-radius: 5px;
            border: 1px solid var(--light-brown);
        }

        /* æ‰‹ç‰Œå€åŸŸ */
        .hand-container {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 30px 0;
            flex-wrap: wrap;
            min-height: 260px;
        }

        .card {
            width: 180px;
            height: 250px;
            background-color: var(--card-bg);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            color: var(--text-dark);
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 8px 16px var(--shadow);
            border: 4px solid #8B4513;
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-15px) scale(1.05);
            box-shadow: 0 20px 30px rgba(0,0,0,0.6);
            z-index: 5;
        }

        /* (6) æ“ä½œç›´è¦ºåŒ– - é¸ä¸­å¡ç‰Œ */
        .card.selected {
            border-color: var(--gold);
            box-shadow: 0 0 25px var(--gold);
            transform: translateY(-20px);
            animation: float 2s infinite ease-in-out;
        }

        .card.played {
            opacity: 0.5;
            cursor: default;
        }

        .card-number {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: var(--gold);
            color: var(--dark-brown);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.3);
        }

        .card-gender {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5rem;
        }

        .male { color: #1e90ff; }
        .female { color: #ff69b4; }

        .card-name {
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            margin-top: 25px;
            color: var(--dark-brown);
            border-bottom: 2px solid var(--light-brown);
            width: 100%;
            padding-bottom: 5px;
        }

        .card-effect {
            font-size: 0.85rem;
            text-align: center;
            margin-top: 10px;
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 5px;
            line-height: 1.3;
        }

        .card-back {
            background: linear-gradient(135deg, var(--dark-brown) 0%, var(--light-brown) 100%);
            color: var(--light-gold);
            justify-content: center;
            font-size: 3rem;
            border: 4px solid var(--gold);
        }

        .card-back .card-name {
            color: var(--light-gold);
            border-bottom-color: var(--gold);
        }

        /* éŠæˆ²æ§åˆ¶å€ */
        .game-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .action-btn {
            min-width: 180px;
            padding: 15px;
            font-size: 1.1rem;
        }
        
        .card-target-btn {
            background-color: var(--light-brown);
            color: white;
            padding: 10px 15px;
            border: 1px solid var(--gold);
            cursor: pointer;
            border-radius: 5px;
            transition: 0.2s;
        }
        
        .card-target-btn:hover {
            background-color: var(--gold);
            color: var(--dark-brown);
        }

        /* é€²åº¦æ¢ */
        .progress-container {
            width: 100%;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            margin: 20px 0;
            overflow: hidden;
            display: none;
        }

        .progress-bar {
            height: 20px;
            background: linear-gradient(to right, var(--dark-gold), var(--gold));
            width: 0%;
            transition: width 0.5s;
            text-align: center;
            color: var(--dark-brown);
            font-weight: bold;
            line-height: 20px;
        }

        /* æ—¥èªŒå€åŸŸ */
        .log-section {
            background-color: rgba(44, 27, 15, 0.9);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px var(--shadow);
            border: 1px solid var(--light-brown);
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: var(--gold);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
        }

        .log-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .log-entry {
            padding: 10px;
            border-radius: 5px;
            background-color: rgba(122, 92, 60, 0.5);
            border-left: 4px solid var(--gold);
            font-size: 0.95rem;
        }

        .log-entry.system { border-left-color: var(--light-gold); font-style: italic; }
        .log-entry.player-action { border-left-color: var(--green); }
        .log-entry.elimination { border-left-color: var(--red); background-color: rgba(139, 0, 0, 0.2); }
        .log-entry.important { border-left-color: #ff4500; font-weight: bold; }

        /* æç¤ºå¡/å‰©é¤˜ç‰Œè¡¨ */
        .hint-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .hint-content {
            background-color: var(--medium-brown);
            border-radius: 10px;
            padding: 30px;
            width: 95%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            border: 3px solid var(--gold);
            position: relative;
        }

        .close-hint {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: var(--light-gold);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .hint-title {
            color: var(--gold);
            font-size: 2rem;
            margin-bottom: 20px;
            text-align: center;
        }

        .cards-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.9rem;
        }

        .cards-table th, .cards-table td {
            border: 1px solid var(--light-brown);
            padding: 10px;
            text-align: center;
        }

        .cards-table th {
            background-color: var(--dark-brown);
            color: var(--gold);
        }

        .cards-table td {
            background-color: rgba(248, 241, 229, 0.1);
        }
        
        .count-badge {
            display: inline-block;
            background-color: var(--dark-brown);
            color: var(--gold);
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: bold;
        }

        /* å¾…æ©Ÿæˆ¿å°éŠæˆ² */
        .waiting-room {
            background-color: rgba(44, 27, 15, 0.9);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
            border: 1px solid var(--light-brown);
        }

        .waiting-title { color: var(--gold); font-size: 1.5rem; margin-bottom: 15px; }

        .dice {
            width: 60px;
            height: 60px;
            background-color: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: var(--dark-brown);
            box-shadow: 0 5px 10px var(--shadow);
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .room-controls { flex-direction: column; }
            .input-group { width: 100%; }
            .hand-container { flex-direction: column; align-items: center; }
            .game-header { flex-direction: column; gap: 15px; }
            .cards-table { font-size: 0.8rem; }
            .cards-table th, .cards-table td { padding: 5px; }
        }

        /* å‹•ç•« */
        @keyframes pulse-border {
            0% { box-shadow: 0 0 10px var(--gold); }
            50% { box-shadow: 0 0 25px var(--gold), 0 0 40px var(--gold); }
            100% { box-shadow: 0 0 10px var(--gold); }
        }
        
        @keyframes float {
            0% { transform: translateY(-20px); }
            50% { transform: translateY(-25px); }
            100% { transform: translateY(-20px); }
        }

        .hidden { display: none !important; }
        .visible { display: block !important; }
        .mt-20 { margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-crown"></i> ã€æƒ…æ›¸ã€‘v0.5</h1>
            <div class="subtitle">ä¿®æ­£ç‰ˆï¼šä¿®å¾©é€£ç·šã€è¨ˆç‰Œã€å›åˆæç¤ºèˆ‡æ“ä½œé«”é©—</div>
        </header>
        
        <div class="game-area">
            <section class="room-section" id="roomSection">
                <h2><i class="fas fa-home"></i> éŠæˆ²å¤§å»³</h2>
                <div class="room-controls">
                    <div class="input-group">
                        <label for="playerName">ä½ çš„åå­—</label>
                        <input type="text" id="playerName" placeholder="è¼¸å…¥ä½ çš„åå­—" value="ç©å®¶">
                    </div>
                    
                    <div class="input-group">
                        <label for="roomId">æˆ¿é–“ID</label>
                        <input type="text" id="roomId" placeholder="è¼¸å…¥æˆ¿é–“ID">
                    </div>
                    
                    <div class="input-group">
                        <label for="avatar">é¸æ“‡é ­åƒ</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <div id="avatarDisplay" class="player-avatar">ğŸ˜Š</div>
                            <button id="randomAvatar" style="flex-grow: 1;">éš¨æ©Ÿ</button>
                        </div>
                    </div>
                    
                    <button id="joinRoom" class="success-btn">
                        <i class="fas fa-door-open"></i> åŠ å…¥/å‰µå»ºæˆ¿é–“
                    </button>
                    
                    <button id="startGame" class="success-btn" disabled>
                        <i class="fas fa-play"></i> é–‹å§‹éŠæˆ²
                    </button>
                    
                    <button id="leaveRoom" class="danger-btn" disabled>
                        <i class="fas fa-sign-out-alt"></i> é›¢é–‹æˆ¿é–“
                    </button>
                </div>
                
                <div class="players-container" id="playersContainer">
                    <div class="text-center" style="grid-column: 1 / -1; padding: 20px; color: var(--light-gold);">
                        è«‹è¼¸å…¥åå­—ä¸¦åŠ å…¥æˆ¿é–“...
                    </div>
                </div>
                
                <div class="waiting-room" id="waitingRoomArea">
                    <div class="waiting-title">ç­‰å¾…éŠæˆ²é–‹å§‹...</div>
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
                        <p>ç­‰å¾…æ™‚å¯ä»¥æ“²éª°å­æ¯”å¤§å°</p>
                        <div style="display: flex; gap: 20px; margin: 10px 0;">
                            <div class="dice" id="dice1">?</div>
                            <div class="dice" id="dice2">?</div>
                        </div>
                        <button id="rollDice"><i class="fas fa-dice"></i> æ“²éª°å­</button>
                        <div id="diceResult" style="height: 20px; color: var(--gold);"></div>
                    </div>
                </div>
            </section>
            
            <section class="game-section" id="gameSection">
                <div class="game-header">
                    <div>
                        <h2><i class="fas fa-chess-board"></i> éŠæˆ²é€²è¡Œä¸­</h2>
                        <div class="game-info">
                            <div class="deck-info">
                                <i class="fas fa-layer-group"></i> ç‰Œåº«å‰©é¤˜: <span id="deckCount" style="color: var(--gold); font-weight: bold;">0</span>
                            </div>
                            <div class="turn-info">
                                <i class="fas fa-user-clock"></i> ç•¶å‰å›åˆ: <span id="currentPlayerName" style="color: var(--green); font-weight: bold;">-</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button id="showHint">
                            <i class="fas fa-list-ol"></i> è¨˜ç‰Œè¡¨
                        </button>
                    </div>
                </div>
                
                <div class="hand-container" id="handContainer">
                    </div>
                
                <div class="game-controls">
                    <button id="drawCard" class="action-btn" disabled>
                        <i class="fas fa-hand-paper"></i> æŠ½ä¸€å¼µç‰Œ
                    </button>
                    <button id="playCard" class="action-btn" disabled>
                        <i class="fas fa-play-circle"></i> æ‰“å‡ºé¸ä¸­çš„ç‰Œ
                    </button>
                    <div id="turnInstruction" style="width: 100%; text-align: center; margin-top: 10px; color: var(--light-gold); font-style: italic;">
                        ç­‰å¾…å…¶ä»–ç©å®¶è¡Œå‹•...
                    </div>
                </div>
                
                <div id="playerSelection" class="hidden" style="margin-top: 20px; padding: 20px; background-color: rgba(44, 27, 15, 0.7); border-radius: 10px; border: 1px solid var(--gold);">
                    <h3 style="color: var(--gold); margin-bottom: 10px;">é¸æ“‡ç›®æ¨™ç©å®¶</h3>
                    <div id="selectablePlayers" style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;"></div>
                    <div style="text-align: center; margin-top: 15px;">
                        <button id="cancelSelection" class="danger-btn">å–æ¶ˆ</button>
                    </div>
                </div>
                
                <div id="guessSelection" class="hidden" style="margin-top: 20px; padding: 20px; background-color: rgba(44, 27, 15, 0.7); border-radius: 10px; border: 1px solid var(--gold);">
                    <h3 style="color: var(--gold); margin-bottom: 10px;">çŒœæ¸¬ <span id="guessTargetName">-</span> çš„æ‰‹ç‰Œ</h3>
                    <div id="guessOptions" style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;"></div>
                    <div style="text-align: center; margin-top: 15px;">
                        <button id="cancelGuess" class="danger-btn">å–æ¶ˆ</button>
                    </div>
                </div>
            </section>
            
            <section class="log-section">
                <div class="log-title">
                    <span><i class="fas fa-scroll"></i> éŠæˆ²ç´€éŒ„</span>
                    <button id="clearLog" style="background: none; border: none; color: var(--light-gold); font-size: 0.9rem;">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
                <div class="log-content" id="gameLog">
                    <div class="log-entry system">
                        <i class="fas fa-info-circle"></i> æ­¡è¿ä¾†åˆ°æƒ…æ›¸ï¼è«‹å»ºç«‹æˆ–åŠ å…¥æˆ¿é–“ã€‚
                    </div>
                </div>
            </section>
        </div>
    </div>
    
    <div class="hint-modal" id="hintModal">
        <div class="hint-content">
            <button class="close-hint" id="closeHint">&times;</button>
            <h2 class="hint-title">å‰©é¤˜å¡ç‰Œè¨˜ç‰Œå™¨</h2>
            <p style="text-align: center; margin-bottom: 15px; color: var(--light-gold);">
                (2) è¨ˆç®—å…¬å¼ï¼šç¸½å¼µæ•¸ - æ£„ç‰Œå †å‡ºç¾çš„å¼µæ•¸ (ä¸å«åˆå§‹æš—ç‰Œèˆ‡å°æ‰‹æ‰‹ç‰Œ)
            </p>
            <table class="cards-table">
                <thead>
                    <tr>
                        <th width="10%">é»æ•¸</th>
                        <th width="20%">è§’è‰²</th>
                        <th width="10%">ç¸½æ•¸</th>
                        <th width="10%">å‰©é¤˜</th>
                        <th width="50%">æŠ€èƒ½</th>
                    </tr>
                </thead>
                <tbody id="cardsTableBody">
                    </tbody>
            </table>
        </div>
    </div>
    
    <script>
        // --- 1. éŠæˆ²è³‡æ–™è¨­å®š ---
        const CARDS = {
            1: { name: "åˆºå®¢", score: 1, count: 3, effect: "è¢«çŒœä¸­èº«åˆ†æ™‚ï¼ŒçŒœæ¸¬è€…å‡ºå±€ï¼Œä½ æ£„ç‰Œé‡æŠ½ã€‚" },
            2: { name: "è¡›å…µ", score: 2, count: 5, effect: "çŒœä¸€ä½ç©å®¶æ‰‹ç‰Œ(éè¡›å…µ)ï¼ŒçŒœå°å°æ–¹å‡ºå±€ã€‚" },
            2.5: { name: "å…µé•·", score: 2, count: 1, effect: "çŒœæ‰€æœ‰ç©å®¶æ‰‹ç‰Œ(éè¡›å…µ)ï¼ŒçŒœå°å°æ–¹å‡ºå±€ã€‚" }, // æ“´å……è¦å‰‡
            3: { name: "ç¥çˆ¶", score: 3, count: 2, effect: "æŸ¥çœ‹ä¸€ä½ç©å®¶çš„æ‰‹ç‰Œã€‚" },
            3.5: { name: "é‚±æ¯”ç‰¹", score: 3, count: 2, effect: "é¸ä¸€ä½ç©å®¶æ¯”å¤§å°ã€‚åŒæ€§:å°å‡ºå±€; ç•°æ€§:å¤§å‡ºå±€ã€‚" }, // æ“´å……è¦å‰‡
            4: { name: "ç”·çˆµ", score: 4, count: 2, effect: "èˆ‡ä¸€ä½ç©å®¶æ¯”å¤§å°ï¼Œé»æ•¸å°çš„å‡ºå±€ã€‚" },
            4.5: { name: "é è¨€å®¶", score: 4, count: 2, effect: "æŠ½ä¸€ç‰Œï¼Œå°‡å…¶æˆ–æ‰‹ç‰Œæ”¾å›ç‰Œåº«åº•ã€‚" }, // æ“´å……è¦å‰‡
            5: { name: "ä¾å¥³", score: 5, count: 2, effect: "ç›´åˆ°ä¸‹å›åˆå‰ï¼Œå…ç–«æ‰€æœ‰æ•ˆæœã€‚" },
            5.5: { name: "å°ä¸‘", score: 5, count: 2, effect: "è¤‡è£½ä¸Šä¸€å€‹ç©å®¶æ‰“å‡ºçš„ç‰Œçš„æ•ˆæœã€‚" }, // æ“´å……è¦å‰‡
            6: { name: "ç‹å­", score: 6, count: 1, effect: "æŒ‡å®šç©å®¶æ£„æ‰æ‰‹ç‰Œä¸¦é‡æŠ½(å¯ä»¥æ˜¯è‡ªå·±)ã€‚" },
            7: { name: "åœ‹ç‹", score: 7, count: 1, effect: "èˆ‡ä¸€ä½ç©å®¶äº¤æ›æ‰‹ç‰Œã€‚" },
            8: { name: "ä¼¯çˆµå¤«äºº", score: 8, count: 1, effect: "æ‰‹ä¸­æœ‰åœ‹ç‹æˆ–ç‹å­æ™‚ï¼Œå¿…é ˆæ‰“å‡ºæ­¤ç‰Œã€‚" },
            9: { name: "å…¬ä¸»", score: 9, count: 1, effect: "è¢«æ£„æ‰æ™‚ç›´æ¥å‡ºå±€ã€‚æ¯”å¤§å°å¿…å‹ã€‚" }
        };
        
        const EMOJIS = ["ğŸ˜€", "ğŸ˜", "ğŸ¤ ", "ğŸ§", "ğŸ¤©", "ğŸ¥³", "ğŸ˜‡", "ğŸ˜ˆ", "ğŸ‘»", "ğŸ¤–", "ğŸ‘½", "ğŸ¶", "ğŸ±", "ğŸ¼", "ğŸ¦Š"];
        
        // --- 2. å…¨åŸŸè®Šæ•¸ ---
        let peer = null;
        let conn = null; // å®¢æˆ¶ç«¯ç”¨
        let hostConnections = []; // æˆ¿ä¸»ç”¨ï¼šå„²å­˜æ‰€æœ‰é€£ç·š
        let isHost = false;
        let myPlayerId = null;
        let myName = "ç©å®¶";
        let myAvatar = "ğŸ˜Š";
        let currentRoomId = "";
        
        // éŠæˆ²ç‹€æ…‹ (éœ€åŒæ­¥)
        let gameState = {
            players: [], // {id, name, avatar, isHost, hand:[], isEliminated, isProtected}
            deck: [],
            discardPile: [], // {card, playedBy}
            currentPlayerIndex: 0,
            phase: "waiting", // waiting, playing
            logs: []
        };

        // æœ¬åœ°æš«å­˜
        let selectedHandIndex = -1;
        let tempTargetPlayerId = null; // ç”¨æ–¼æŠ€èƒ½ç›®æ¨™é¸æ“‡

        // --- 3. åˆå§‹åŒ–èˆ‡äº‹ä»¶ ---
        document.addEventListener("DOMContentLoaded", () => {
            document.getElementById("roomId").value = generateRoomId();
            
            // ç¶å®šæŒ‰éˆ•
            document.getElementById("randomAvatar").onclick = randomizeAvatar;
            document.getElementById("joinRoom").onclick = handleJoinRoom;
            document.getElementById("startGame").onclick = tryStartGame;
            document.getElementById("leaveRoom").onclick = handleLeaveRoom; // (5) ä¿®æ­£é‡ç½®å•é¡Œ
            document.getElementById("showHint").onclick = updateAndShowHint;
            document.getElementById("closeHint").onclick = () => document.getElementById("hintModal").style.display = "none";
            document.getElementById("hintModal").onclick = (e) => { if(e.target.id === "hintModal") document.getElementById("hintModal").style.display = "none"; };
            
            document.getElementById("drawCard").onclick = actionDrawCard;
            document.getElementById("playCard").onclick = preparePlayCard;
            document.getElementById("cancelSelection").onclick = resetSelectionUI;
            document.getElementById("cancelGuess").onclick = resetSelectionUI;
            document.getElementById("clearLog").onclick = () => document.getElementById("gameLog").innerHTML = "";
            document.getElementById("rollDice").onclick = playDiceGame;
            
            randomizeAvatar();
        });

        function generateRoomId() {
            return Math.random().toString(36).substring(2, 7).toUpperCase();
        }

        function randomizeAvatar() {
            myAvatar = EMOJIS[Math.floor(Math.random() * EMOJIS.length)];
            document.getElementById("avatarDisplay").textContent = myAvatar;
            if(gameState.phase === "waiting" && myPlayerId) {
                sendData({type: "UPDATE_PROFILE", name: myName, avatar: myAvatar});
            }
        }

        // --- 4. PeerJS é€£ç·šé‚è¼¯ (ä¿®æ­£å•é¡Œ 1: é€£ç·šå¯è¦‹æ€§) ---
        function handleJoinRoom() {
            myName = document.getElementById("playerName").value || "ç©å®¶";
            const roomIdInput = document.getElementById("roomId").value.trim();
            
            if(!roomIdInput) { alert("è«‹è¼¸å…¥æˆ¿é–“ID"); return; }
            
            document.getElementById("joinRoom").disabled = true;
            document.getElementById("playerName").disabled = true;
            document.getElementById("roomId").disabled = true;
            
            // å˜—è©¦é€£ç·šåˆ¤æ–· (ç°¡å–®é‚è¼¯ï¼šè‹¥IDæ˜¯è‡ªå·±ç”Ÿæˆçš„ä¸”ç„¡å‰ç¶´ï¼Œè¦–ç‚ºæˆ¿ä¸»å˜—è©¦)
            // é€™è£¡ç‚ºäº†ç°¡åŒ–ï¼Œå¦‚æœä½¿ç”¨è€…æŒ‰åŠ å…¥ï¼Œæˆ‘å€‘å…ˆå‡è¨­ä»–æ˜¯æˆ¿ä¸»å»ºç«‹é€£ç·šï¼Œå¦‚æœIDè¡çªä»£è¡¨æˆ¿é–“å­˜åœ¨(ä½†åœ¨PeerJSæ¯”è¼ƒé›£é€™æ¨£æ¸¬)
            // æ”¹ç‚ºï¼šä½¿ç”¨è€…æ±ºå®šæ˜¯å¦ç‚ºæˆ¿ä¸»æ¯”è¼ƒé›£ï¼Œæˆ‘å€‘æ¡ç”¨ "å˜—è©¦é€£ç·š Host" -> "å¤±æ•—å‰‡è‡ªå·±ç•¶ Host" çš„é‚è¼¯å¤ªæ…¢
            // é€™è£¡æ¡ç”¨ç°¡å–®ç­–ç•¥ï¼šå¦‚æœç¶²å€ç„¡åƒæ•¸ï¼ŒIDå°±æ˜¯æˆ¿é–“è™Ÿã€‚PeerID = "LoveLetter_" + RoomID + "_" + Random
            
            // ä¿®æ­£ç­–ç•¥ï¼š
            // æˆ¿ä¸» PeerIDå›ºå®šç‚º: LL_HOST_æˆ¿é–“è™Ÿ
            // ç©å®¶ PeerIDéš¨æ©Ÿ: LL_GUEST_éš¨æ©Ÿ
            
            const hostPeerId = `LL_HOST_${roomIdInput}`;
            
            // å…ˆå˜—è©¦ç•¶ä½œå®¢äººé€£ç·š
            const tempPeer = new Peer();
            
            tempPeer.on('open', (id) => {
                // å˜—è©¦é€£ç·šåˆ° Host
                const connAttempt = tempPeer.connect(hostPeerId);
                
                connAttempt.on('open', () => {
                    // é€£ç·šæˆåŠŸï¼Œæˆ‘æ˜¯å®¢äºº
                    isHost = false;
                    myPlayerId = id;
                    peer = tempPeer;
                    conn = connAttempt;
                    currentRoomId = roomIdInput;
                    setupClient();
                    logSystem(`å·²é€£ç·šåˆ°æˆ¿é–“ ${roomIdInput}`);
                    
                    // (1) é—œéµä¿®æ­£ï¼šåŠ å…¥å¾Œç«‹å³ç™¼é€å€‹äººè³‡è¨Š
                    conn.send({
                        type: "JOIN",
                        player: { id: myPlayerId, name: myName, avatar: myAvatar }
                    });
                    
                    document.getElementById("leaveRoom").disabled = false;
                });
                
                // å¦‚æœå¹¾ç§’å…§æ²’é€£ä¸Šï¼Œæˆ–æ˜¯ç™¼ç”ŸéŒ¯èª¤ï¼Œå‰‡è‡ªå·±ç•¶æˆ¿ä¸»
                setTimeout(() => {
                    if(!conn || !conn.open) {
                        console.log("é€£ç·šä¸»æ©Ÿè¶…æ™‚ï¼Œå˜—è©¦å»ºç«‹æˆ¿é–“...");
                        tempPeer.destroy();
                        createRoomAsHost(roomIdInput);
                    }
                }, 2000);
                
                connAttempt.on('error', () => {
                    tempPeer.destroy();
                    createRoomAsHost(roomIdInput);
                });
            });
        }
        
        function createRoomAsHost(roomId) {
            isHost = true;
            currentRoomId = roomId;
            const hostId = `LL_HOST_${roomId}`;
            
            peer = new Peer(hostId);
            
            peer.on('open', (id) => {
                myPlayerId = id;
                logSystem(`æˆ¿é–“å·²å»ºç«‹ ID: ${roomId}`);
                logSystem("ç­‰å¾…å…¶ä»–ç©å®¶åŠ å…¥...");
                
                document.getElementById("joinRoom").style.display = "none";
                document.getElementById("startGame").disabled = false;
                document.getElementById("leaveRoom").disabled = false;
                
                // æˆ¿ä¸»è‡ªå·±å…ˆå…¥åˆ—
                gameState.players = [{
                    id: id, name: myName, avatar: myAvatar, isHost: true, 
                    hand: [], isEliminated: false, isProtected: false
                }];
                updateUI();
            });
            
            peer.on('connection', (connection) => {
                hostConnections.push(connection);
                
                connection.on('data', (data) => {
                    handleHostData(data, connection);
                });
                
                connection.on('close', () => {
                    // è™•ç†æ–·ç·š (ç°¡å–®ç‰ˆï¼šä¸åšè¤‡é›œé‡é€£)
                    gameState.players = gameState.players.filter(p => p.id !== connection.peer);
                    broadcastState();
                });
            });
            
            peer.on('error', (err) => {
                alert("å»ºç«‹æˆ¿é–“å¤±æ•— (IDå¯èƒ½è¢«ä½”ç”¨): " + err);
                handleLeaveRoom();
            });
        }
        
        function setupClient() {
            document.getElementById("joinRoom").style.display = "none";
            document.getElementById("startGame").style.display = "none"; // å®¢äººä¸èƒ½é–‹å§‹
            
            conn.on('data', (data) => {
                handleClientData(data);
            });
            
            conn.on('close', () => {
                alert("æˆ¿ä¸»å·²æ–·é–‹é€£ç·š");
                handleLeaveRoom();
            });
        }
        
        // --- 5. è³‡æ–™è™•ç† (Host & Client) ---
        
        // çµ±ä¸€ç™¼é€è³‡æ–™
        function sendData(data) {
            if (isHost) {
                handleHostData(data, null); // æˆ¿ä¸»è‡ªå·±ç™¼çµ¦è‡ªå·±è™•ç†
            } else if (conn && conn.open) {
                conn.send(data);
            }
        }
        
        function broadcastState() {
            if (!isHost) return;
            // (1) ä¿®æ­£ï¼šç¢ºä¿åŒ…å«æ‰€æœ‰å¿…è¦è³‡è¨Š
            const data = { type: "SYNC_STATE", state: gameState };
            hostConnections.forEach(c => {
                if(c.open) c.send(data);
            });
            updateUI(); // æˆ¿ä¸»è‡ªå·±æ›´æ–°
        }
        
        // Host è™•ç†é‚è¼¯
        function handleHostData(data, senderConn) {
            switch(data.type) {
                case "JOIN":
                    // (3) å„ªåŒ–æ—¥èªŒï¼šé¡¯ç¤ºåŠ å…¥è€…åç¨±
                    logSystem(`ç©å®¶ ${data.player.name} åŠ å…¥äº†æˆ¿é–“`);
                    // é¿å…é‡è¤‡åŠ å…¥
                    if (!gameState.players.find(p => p.id === data.player.id)) {
                        gameState.players.push({
                            ...data.player,
                            hand: [], isEliminated: false, isProtected: false
                        });
                        broadcastState(); // (1) é—œéµï¼šæ–°ç©å®¶åŠ å…¥å¾Œç«‹åˆ»å»£æ’­
                    }
                    break;
                    
                case "UPDATE_PROFILE":
                    const p = gameState.players.find(p => p.id === (senderConn ? senderConn.peer : myPlayerId));
                    if(p) {
                        p.name = data.name;
                        p.avatar = data.avatar;
                        broadcastState();
                    }
                    break;
                    
                case "ACTION_PLAY_CARD":
                    // è™•ç†å‡ºç‰Œé‚è¼¯
                    processCardEffect(data.playerId, data.card, data.targetId, data.guessValue);
                    break;
                    
                case "ACTION_DRAW":
                    hostHandleDraw(data.playerId);
                    break;
            }
        }
        
        // Client è™•ç†é‚è¼¯
        function handleClientData(data) {
            switch(data.type) {
                case "SYNC_STATE":
                    gameState = data.state;
                    updateUI();
                    break;
                case "LOG":
                    logRaw(data.message, data.style);
                    break;
            }
        }
        
        // --- 6. éŠæˆ²æ ¸å¿ƒé‚è¼¯ (Host Only) ---
        
        function tryStartGame() {
            if(gameState.players.length < 2) {
                alert("è‡³å°‘éœ€è¦2åç©å®¶ï¼");
                return;
            }
            
            // åˆå§‹åŒ–ç‰Œå †
            let deck = [];
            for(let val in CARDS) {
                const count = CARDS[val].count;
                for(let i=0; i<count; i++) {
                    deck.push({ value: parseFloat(val), uid: Math.random().toString(36) });
                }
            }
            
            // æ´—ç‰Œ
            deck.sort(() => Math.random() - 0.5);
            
            // ç§»é™¤ä¸€å¼µç‰Œ (æš—ç‰Œ)
            const removed = deck.pop();
            // å¦‚æœæ˜¯2äººå±€ï¼Œé¡å¤–ç§»é™¤3å¼µäº®ç‰Œ (ç°¡åŒ–è¦å‰‡ï¼šæš«ä¸å¯¦ä½œäº®ç‰Œï¼ŒåªåšåŸºæœ¬ç§»é™¤)
            
            gameState.deck = deck;
            gameState.discardPile = [];
            gameState.players.forEach(p => {
                p.hand = [deck.pop()];
                p.isEliminated = false;
                p.isProtected = false;
            });
            
            gameState.currentPlayerIndex = Math.floor(Math.random() * gameState.players.length);
            gameState.phase = "playing";
            
            logSystem("éŠæˆ²é–‹å§‹ï¼");
            logImportant(`åˆå§‹ç§»é™¤äº†ä¸€å¼µç‰Œã€‚`);
            
            broadcastState();
        }
        
        function hostHandleDraw(playerId) {
            const player = gameState.players.find(p => p.id === playerId);
            if(gameState.deck.length > 0) {
                player.hand.push(gameState.deck.pop());
                logPlayer(player.name, "æŠ½äº†ä¸€å¼µç‰Œ");
            } else {
                // ç‰ŒæŠ½å®Œçš„ç‰¹æ®Šç‹€æ³ï¼šæ­¤æ™‚é€šå¸¸æ‰“å‡ºä¸€å¼µæœ€å¾Œçµç®—ï¼Œé€™è£¡ç°¡åŒ–ç‚ºç›´æ¥æŠ½åˆ°ç§»é™¤çš„é‚£å¼µ(è®Šé«”)æˆ–çµæŸ
                // æ¨™æº–è¦å‰‡ï¼šç‰Œåº«ç©ºæ™‚ï¼Œè‹¥éœ€è¦æŠ½ç‰Œï¼Œå‰‡æ‹¿å–æœ€åˆç§»é™¤çš„é‚£å¼µç‰Œ(å¦‚æœæ˜¯2äººå±€é™¤å¤–)ã€‚
                // é€™è£¡ç°¡åŒ–ï¼šæŠ½ä¸€å¼µç©ºæ°£ç‰Œä¸¦çµæŸéŠæˆ²æˆ–ç›´æ¥æ¯”å¤§å°
                logSystem("ç‰Œåº«å·²ç©ºï¼é€²è¡Œæœ€çµ‚çµç®—ã€‚");
                endGameComparison();
                return;
            }
            broadcastState();
        }
        
        function processCardEffect(playerId, card, targetId, guessValue) {
            const player = gameState.players.find(p => p.id === playerId);
            const target = targetId ? gameState.players.find(p => p.id === targetId) : null;
            
            // 1. ç§»é™¤æ‰‹ç‰Œä¸¦åŠ å…¥æ£„ç‰Œå †
            player.hand = player.hand.filter(c => c.uid !== card.uid);
            gameState.discardPile.push({card: card, playedBy: player.name});
            
            logPlayer(player.name, `æ‰“å‡ºäº† ã€${CARDS[card.value].name}ã€‘`);
            
            // è§£é™¤ä¿è­· (è‹¥ä¹‹å‰æœ‰)
            player.isProtected = false;
            
            // æ•ˆæœè™•ç†
            let eliminatedName = null;
            
            switch(card.value) {
                case 1: // åˆºå®¢ï¼šç„¡ä¸»å‹•æ•ˆæœ
                    break;
                case 2: // è¡›å…µ
                case 2.5: // å…µé•·
                    if(target && !target.isProtected) {
                        const targetCard = target.hand[0];
                        // å…µé•·çŒœæ‰€æœ‰æ‰‹ç‰Œï¼Œé€™è£¡ç°¡åŒ–é‚è¼¯ä¸€æ¨£
                        if(targetCard.value == guessValue) {
                            eliminatedName = target.name;
                            target.isEliminated = true;
                            logImportant(`${player.name} çŒœå°äº†ï¼ ${target.name} æ‰‹ç‰Œæ˜¯ ${CARDS[targetCard.value].name}ï¼Œé­åˆ°æ·˜æ±°ï¼`);
                        } else {
                            logSystem(`${player.name} çŒœéŒ¯äº†ã€‚`);
                            // åˆºå®¢åæ®ºé‚è¼¯
                            if(targetCard.value === 1) {
                                player.isEliminated = true;
                                logImportant(`${target.name} æ‰‹æŒåˆºå®¢ï¼ ${player.name} åè¢«æ·˜æ±°ï¼`);
                            }
                        }
                    } else {
                        logSystem("ç„¡æ•ˆçš„ç›®æ¨™æˆ–ç›®æ¨™å—ä¿è­·ã€‚");
                    }
                    break;
                case 3: // ç¥çˆ¶
                    if(target && !target.isProtected) {
                        // å‚³é€ç§äººè¨Šæ¯çµ¦ç™¼å‹•è€… (éœ€è¦PeerJSå®šå‘ç™¼é€ï¼Œé€™è£¡ç°¡åŒ–ç”¨Logç¨å¾®éš±æ™¦ä¸€é»æˆ–æ˜¯åªHostçŸ¥é“)
                        // åœ¨çœŸå¯¦P2Pï¼ŒHostæ‡‰åªç™¼é€çµ¦è©²Playerã€‚
                        // é€™è£¡ç‚ºäº†ç°¡åŒ–ï¼ŒHostç™¼é€ç‰¹æ®ŠLogçµ¦Player
                        sendPrivateLog(player.id, `ğŸ•µï¸ ä½ çœ‹åˆ° ${target.name} çš„æ‰‹ç‰Œæ˜¯ï¼š${CARDS[target.hand[0].value].name}`);
                        logSystem(`${player.name} æŸ¥çœ‹äº† ${target.name} çš„æ‰‹ç‰Œã€‚`);
                    }
                    break;
                case 3.5: // é‚±æ¯”ç‰¹
                case 4: // ç”·çˆµ
                    if(target && !target.isProtected) {
                        const pCard = player.hand[0]; // å‰©ä¸‹é‚£å¼µ
                        const tCard = target.hand[0];
                        logSystem(`æ¯”å¤§å°ï¼š${player.name} vs ${target.name}`);
                        
                        // å…¬ä¸»å¿…å‹é‚è¼¯
                        if(pCard.value === 9) { target.isEliminated = true; eliminatedName = target.name; }
                        else if(tCard.value === 9) { player.isEliminated = true; eliminatedName = player.name; }
                        else if (pCard.value > tCard.value) { target.isEliminated = true; eliminatedName = target.name; }
                        else if (tCard.value > pCard.value) { player.isEliminated = true; eliminatedName = player.name; }
                        else { logSystem("å¹³æ‰‹ï¼ç„¡äººå‡ºå±€ã€‚"); }
                        
                        if(eliminatedName) logImportant(`${eliminatedName} æ¯”å¤§å°è¼¸äº†ï¼Œé­åˆ°æ·˜æ±°ï¼`);
                    }
                    break;
                case 5: // ä¾å¥³
                    player.isProtected = true;
                    logSystem(`${player.name} ç²å¾—äº†ä¿è­·ï¼Œç›´åˆ°ä¸‹å›åˆã€‚`);
                    break;
                case 6: // ç‹å­
                    if(target && !target.isProtected) {
                        const discarded = target.hand.pop();
                        gameState.discardPile.push({card: discarded, playedBy: target.name + "(æ£„)"});
                        logSystem(`${target.name} æ£„æ‰äº† ${CARDS[discarded.value].name}`);
                        
                        if(discarded.value === 9) {
                            target.isEliminated = true;
                            logImportant(`${target.name} æ£„æ‰äº†å…¬ä¸»ï¼Œç›´æ¥æ·˜æ±°ï¼`);
                        } else {
                            // æŠ½æ–°ç‰Œ
                            if(gameState.deck.length > 0) target.hand.push(gameState.deck.pop());
                            else {
                                // æ‹¿ç§»é™¤çš„ç‰Œ(ç°¡åŒ–)
                                logSystem("ç‰Œåº«ç©ºäº†ï¼Œç„¡æ³•è£œç‰Œã€‚"); 
                            }
                        }
                    }
                    break;
                case 7: // åœ‹ç‹
                    if(target && !target.isProtected) {
                        const temp = player.hand[0];
                        player.hand[0] = target.hand[0];
                        target.hand[0] = temp;
                        logSystem(`${player.name} èˆ‡ ${target.name} äº¤æ›äº†æ‰‹ç‰Œï¼`);
                    }
                    break;
                case 9: // å…¬ä¸»
                    player.isEliminated = true;
                    logImportant(`${player.name} æ‰“å‡ºäº†å…¬ä¸»ï¼Œç›´æ¥æ·˜æ±°ï¼`);
                    break;
            }
            
            // æª¢æŸ¥æ˜¯å¦åªå‰©ä¸€äºº
            const activePlayers = gameState.players.filter(p => !p.isEliminated);
            if(activePlayers.length === 1) {
                endGame(activePlayers[0]);
                return;
            }
            
            // ä¸‹ä¸€ä½ç©å®¶
            nextTurn();
        }
        
        function nextTurn() {
            let nextIndex = (gameState.currentPlayerIndex + 1) % gameState.players.length;
            let loopCount = 0;
            
            // æ‰¾ä¸‹ä¸€å€‹æœªæ·˜æ±°çš„ç©å®¶
            while(gameState.players[nextIndex].isEliminated && loopCount < gameState.players.length) {
                nextIndex = (nextIndex + 1) % gameState.players.length;
                loopCount++;
            }
            
            if(gameState.deck.length === 0) {
                endGameComparison();
            } else {
                gameState.currentPlayerIndex = nextIndex;
                broadcastState();
            }
        }
        
        function endGameComparison() {
            let maxVal = -1;
            let winners = [];
            
            gameState.players.forEach(p => {
                if(!p.isEliminated && p.hand.length > 0) {
                    const val = p.hand[0].value;
                    if(val > maxVal) {
                        maxVal = val;
                        winners = [p];
                    } else if (val === maxVal) {
                        winners.push(p);
                    }
                }
            });
            
            endGame(winners.length > 0 ? winners[0] : null); // ç°¡åŒ–ï¼šå–ç¬¬ä¸€å€‹è´å®¶æˆ–å¹³æ‰‹
        }
        
        function endGame(winner) {
            gameState.phase = "ended";
            if(winner) logImportant(`ğŸ† éŠæˆ²çµæŸï¼ç²å‹è€…æ˜¯ï¼š${winner.name}`);
            else logSystem("éŠæˆ²çµæŸï¼Œæ²’æœ‰è´å®¶ï¼Ÿ");
            broadcastState();
        }
        
        function sendPrivateLog(targetId, msg) {
            const conn = hostConnections.find(c => c.peer === targetId);
            if(conn) conn.send({type: "LOG", message: msg, style: "important"});
            else if(targetId === myPlayerId) logImportant(msg); // Hostè‡ªå·±
        }

        // --- 7. UI æ›´æ–°é‚è¼¯ ---
        
        function updateUI() {
            // æ›´æ–°æˆ¿é–“è³‡è¨Š
            document.getElementById("deckCount").textContent = gameState.deck.length;
            
            if (gameState.phase === "waiting") {
                document.getElementById("roomSection").classList.remove("hidden");
                document.getElementById("gameSection").classList.remove("hidden"); // æ”¹ç‚ºä¸¦å­˜æ–¹ä¾¿çœ‹
                document.getElementById("waitingRoomArea").classList.remove("hidden");
                document.getElementById("gameSection").classList.add("hidden");
            } else {
                document.getElementById("roomSection").classList.add("hidden");
                document.getElementById("waitingRoomArea").classList.add("hidden");
                document.getElementById("gameSection").classList.remove("hidden");
            }
            
            // æ›´æ–°ç©å®¶åˆ—è¡¨ (4) å›åˆé †åºèˆ‡è¦–è¦ºå„ªåŒ–
            const container = document.getElementById("playersContainer");
            container.innerHTML = "";
            
            gameState.players.forEach((p, index) => {
                const isCurrent = (gameState.phase === "playing" && index === gameState.currentPlayerIndex);
                const isMe = p.id === myPlayerId;
                
                const cardDiv = document.createElement("div");
                cardDiv.className = `player-card ${p.isHost ? 'host' : ''} ${isCurrent ? 'current-turn' : ''} ${p.isEliminated ? 'eliminated' : ''}`;
                
                // ä¸‹å®¶æ¨™ç¤º
                let nextBadge = "";
                if(gameState.phase === "playing" && !p.isEliminated) {
                     // ç°¡å–®è¨ˆç®—ä¸‹ä¸€å€‹é †ä½
                     let nextIdx = (gameState.currentPlayerIndex + 1) % gameState.players.length;
                     while(gameState.players[nextIdx].isEliminated) {
                         nextIdx = (nextIdx + 1) % gameState.players.length;
                     }
                     if(index === nextIdx) nextBadge = `<span style="background:#555; color:#fff; font-size:0.7rem; padding:2px 5px; border-radius:4px; margin-left:5px;">ä¸‹ä¸€ä½</span>`;
                }

                let statusText = p.isEliminated ? '<span style="color:red">(å‡ºå±€)</span>' : (p.isProtected ? '<span style="color:lightblue">(å—ä¿è­·)</span>' : '');
                if(isCurrent) statusText += ' <span style="color:gold; font-weight:bold;">(æ€è€ƒä¸­...)</span>';

                cardDiv.innerHTML = `
                    <div class="player-avatar">${p.avatar}</div>
                    <div class="player-info">
                        <div class="player-name">
                            ${p.name} ${isMe ? '(ä½ )' : ''} ${nextBadge}
                        </div>
                        <div class="player-status">${statusText}</div>
                    </div>
                    ${isCurrent ? '<div class="turn-badge">ç•¶å‰å›åˆ</div>' : ''}
                `;
                container.appendChild(cardDiv);
                
                if(isCurrent) {
                    document.getElementById("currentPlayerName").textContent = p.name;
                }
            });
            
            // æ›´æ–°æ‰‹ç‰Œ
            updateHand();
            
            // æ›´æ–°æ§åˆ¶æŒ‰éˆ•
            updateControls();
        }
        
        function updateHand() {
            const handContainer = document.getElementById("handContainer");
            handContainer.innerHTML = "";
            
            const myData = gameState.players.find(p => p.id === myPlayerId);
            if(myData && !myData.isEliminated) {
                myData.hand.forEach((card, index) => {
                    const el = document.createElement("div");
                    el.className = `card ${index === selectedHandIndex ? 'selected' : ''}`;
                    const cardInfo = CARDS[card.value];
                    el.innerHTML = `
                        <div class="card-number">${card.value}</div>
                        <div class="card-gender ${index % 2 === 0 ? 'male' : 'female'}">
                            <i class="fas fa-${index % 2 === 0 ? 'mars' : 'venus'}"></i>
                        </div>
                        <div class="card-name">${cardInfo.name}</div>
                        <div class="card-effect">${cardInfo.effect}</div>
                    `;
                    
                    // (6) æ“ä½œç›´è¦ºåŒ–ï¼šé»æ“Šå¡ç‰‡é¸æ“‡
                    el.onclick = () => {
                        if(gameState.phase === "playing" && isMyTurn() && !hasDrawnCard()) {
                            // é‚„æ²’æŠ½ç‰Œä¸èƒ½é¸ç‰Œ(é™¤éæ˜¯ç‰¹æ®Šè¦å‰‡ï¼Œä½†é€šå¸¸è¦å…ˆæŠ½)
                            return; 
                        }
                        // ä¼¯çˆµå¤«äººå¼·åˆ¶æª¢æŸ¥
                        const handValues = myData.hand.map(c => c.value);
                        if((handValues.includes(7) || handValues.includes(6)) && card.value !== 8 && handValues.includes(8)) {
                            alert("ä½ æœ‰åœ‹ç‹æˆ–ç‹å­ï¼Œå¿…é ˆæ‰“å‡ºä¼¯çˆµå¤«äººï¼");
                            return; 
                        }
                        
                        selectedHandIndex = index;
                        updateHand(); // é‡ç¹ªä»¥é¡¯ç¤ºé¸ä¸­ç‹€æ…‹
                        updateControls();
                    };
                    
                    handContainer.appendChild(el);
                });
            } else if (myData && myData.isEliminated) {
                 handContainer.innerHTML = `<div style="color:var(--red); font-size:1.5rem;">ä½ å·²å‡ºå±€ ğŸ‘»</div>`;
            }
        }
        
        function updateControls() {
            const myTurn = isMyTurn();
            const drawn = hasDrawnCard();
            
            const btnDraw = document.getElementById("drawCard");
            const btnPlay = document.getElementById("playCard");
            const txt = document.getElementById("turnInstruction");
            
            if(myTurn) {
                if(!drawn) {
                    btnDraw.disabled = false;
                    btnDraw.classList.add("pulse"); // åŠ å¼·æç¤º
                    btnPlay.disabled = true;
                    btnPlay.classList.remove("pulse");
                    txt.textContent = "è¼ªåˆ°ä½ äº†ï¼Œè«‹æŠ½ä¸€å¼µç‰Œï¼";
                } else {
                    btnDraw.disabled = true;
                    btnDraw.classList.remove("pulse");
                    btnPlay.disabled = selectedHandIndex === -1;
                    if(selectedHandIndex !== -1) btnPlay.classList.add("pulse");
                    txt.textContent = "è«‹é¸æ“‡ä¸€å¼µæ‰‹ç‰Œæ‰“å‡º";
                }
            } else {
                btnDraw.disabled = true;
                btnPlay.disabled = true;
                btnDraw.classList.remove("pulse");
                txt.textContent = `ç­‰å¾… ${document.getElementById("currentPlayerName").textContent} è¡Œå‹•...`;
            }
        }
        
        function isMyTurn() {
            if(gameState.phase !== "playing") return false;
            const currentP = gameState.players[gameState.currentPlayerIndex];
            return currentP && currentP.id === myPlayerId;
        }
        
        function hasDrawnCard() {
            const myData = gameState.players.find(p => p.id === myPlayerId);
            return myData && myData.hand.length === 2;
        }
        
        // --- 8. ç©å®¶å‹•ä½œ ---
        
        function actionDrawCard() {
            sendData({ type: "ACTION_DRAW", playerId: myPlayerId });
        }
        
        function preparePlayCard() {
            if(selectedHandIndex === -1) return;
            const myData = gameState.players.find(p => p.id === myPlayerId);
            const card = myData.hand[selectedHandIndex];
            const val = card.value;
            
            // éœ€è¦æŒ‡å®šå°è±¡çš„ç‰Œ
            const needTarget = [2, 2.5, 3, 3.5, 4, 6, 7].includes(val); // 1, 4.5, 5, 5.5, 8, 9 ä¸éœ€è¦æˆ–å°è±¡å›ºå®š
            
            if(needTarget) {
                showTargetSelection(val);
            } else {
                // ç›´æ¥æ‰“å‡º
                confirmPlayCard(card, null, null);
            }
        }
        
        function showTargetSelection(cardValue) {
            const container = document.getElementById("selectablePlayers");
            container.innerHTML = "";
            document.getElementById("playerSelection").classList.remove("hidden");
            
            gameState.players.forEach(p => {
                if(!p.isEliminated) {
                    const btn = document.createElement("button");
                    btn.className = "card-target-btn";
                    btn.innerHTML = p.id === myPlayerId ? `${p.name} (è‡ªå·±)` : p.name;
                    
                    // è¦å‰‡æª¢æŸ¥ï¼šå¦‚æœæ˜¯ç‹å­(6)å¯ä»¥é¸è‡ªå·±ï¼Œå…¶ä»–äººä¸èƒ½é¸è‡ªå·±
                    if(cardValue !== 6 && p.id === myPlayerId) {
                        btn.disabled = true;
                        btn.style.opacity = 0.5;
                    }
                    
                    if(p.isProtected && cardValue !== 6) { // é€™è£¡ç°¡åŒ–ï¼šä¿è­·æ™‚ä¸èƒ½é¸ï¼Œç‹å­ç‰¹ä¾‹å¯é¸è‡ªå·±
                         if(p.id !== myPlayerId) {
                            btn.disabled = true;
                            btn.innerHTML += " (å—ä¿è­·)";
                         }
                    }

                    btn.onclick = () => {
                        tempTargetPlayerId = p.id;
                        document.getElementById("playerSelection").classList.add("hidden");
                        
                        // è¡›å…µéœ€è¦çŒœç‰Œ
                        if(cardValue === 2 || cardValue === 2.5) {
                            showGuessSelection(p.name);
                        } else {
                            const myData = gameState.players.find(tp => tp.id === myPlayerId);
                            confirmPlayCard(myData.hand[selectedHandIndex], tempTargetPlayerId, null);
                        }
                    };
                    container.appendChild(btn);
                }
            });
        }
        
        function showGuessSelection(targetName) {
            document.getElementById("guessTargetName").textContent = targetName;
            const container = document.getElementById("guessOptions");
            container.innerHTML = "";
            document.getElementById("guessSelection").classList.remove("hidden");
            
            // ç”¢ç”Ÿé™¤äº†è¡›å…µä»¥å¤–çš„é¸é …
            for(let key in CARDS) {
                const val = parseFloat(key);
                if(val !== 2 && val !== 2.5) { // ä¸èƒ½çŒœè¡›å…µ
                    const btn = document.createElement("button");
                    btn.className = "card-target-btn";
                    btn.textContent = `${val} ${CARDS[key].name}`;
                    btn.onclick = () => {
                        document.getElementById("guessSelection").classList.add("hidden");
                        const myData = gameState.players.find(tp => tp.id === myPlayerId);
                        confirmPlayCard(myData.hand[selectedHandIndex], tempTargetPlayerId, val);
                    };
                    container.appendChild(btn);
                }
            }
        }
        
        function resetSelectionUI() {
            document.getElementById("playerSelection").classList.add("hidden");
            document.getElementById("guessSelection").classList.add("hidden");
        }
        
        function confirmPlayCard(card, targetId, guessVal) {
            sendData({
                type: "ACTION_PLAY_CARD",
                playerId: myPlayerId,
                card: card,
                targetId: targetId,
                guessValue: guessVal
            });
            
            // é‡ç½®æœ¬åœ°ç‹€æ…‹
            selectedHandIndex = -1;
            tempTargetPlayerId = null;
            resetSelectionUI();
        }
        
        // --- (5) ä¿®æ­£ï¼šé›¢é–‹æˆ¿é–“ ---
        function handleLeaveRoom() {
            if(confirm("ç¢ºå®šè¦é›¢é–‹æˆ¿é–“å—ï¼Ÿ")) {
                if(peer) peer.destroy();
                // ä½¿ç”¨é‡è¼‰é é¢ä¾†å¾¹åº•æ¸…é™¤ç‹€æ…‹ï¼Œé€™æ˜¯æœ€ä¹¾æ·¨è§£æ±ºIDé‡è¤‡èˆ‡ç‹€æ…‹æ®˜ç•™çš„æ–¹æ³•
                location.reload();
            }
        }
        
        // --- (2) ä¿®æ­£ï¼šè¨ˆç®—å‰©é¤˜ç‰Œæ•¸ ---
        function updateAndShowHint() {
            const tbody = document.getElementById("cardsTableBody");
            tbody.innerHTML = "";
            
            // è¨ˆç®—å·²å‡ºéçš„ç‰Œ (æ£„ç‰Œå †)
            let playedCounts = {};
            gameState.discardPile.forEach(item => {
                const v = item.card.value;
                playedCounts[v] = (playedCounts[v] || 0) + 1;
            });
            
            // å»ºç«‹è¡¨æ ¼
            for(let key in CARDS) {
                const card = CARDS[key];
                const played = playedCounts[key] || 0;
                const remaining = card.count - played;
                
                const tr = document.createElement("tr");
                // æ¨™è¨˜å‰©ä¸‹ç‚º0çš„è®Šç°
                if(remaining <= 0) tr.style.opacity = "0.3";
                
                tr.innerHTML = `
                    <td><span class="count-badge">${key}</span></td>
                    <td style="color:var(--dark-brown); font-weight:bold;">${card.name}</td>
                    <td>${card.count}</td>
                    <td style="color:${remaining > 0 ? 'var(--green)' : 'var(--red)'}; font-weight:bold;">${remaining < 0 ? 0 : remaining}</td>
                    <td style="text-align:left; font-size:0.85rem;">${card.effect}</td>
                `;
                tbody.appendChild(tr);
            }
            
            document.getElementById("hintModal").style.display = "flex";
        }
        
        // --- è¼”åŠ©åŠŸèƒ½ ---
        function logSystem(msg) {
            logRaw(msg, "system");
            // Host ä¹Ÿè¦è² è²¬è¨˜éŒ„åˆ°ç‹€æ…‹çµ¦å…¶ä»–äººåŒæ­¥ (ç°¡åŒ–ç‰ˆç•¥éï¼Œç”±å„Clientè‡ªå·±Log)
            // é€™è£¡ç‚ºäº†é«”é©—å¥½ï¼ŒActionæ™‚ç”±Hostå»£æ’­LOGäº‹ä»¶
        }
        function logPlayer(name, action) {
             const msg = `${name} ${action}`;
             logRaw(msg, "player-action");
             if(isHost) hostConnections.forEach(c => c.open && c.send({type: "LOG", message: msg, style: "player-action"}));
        }
        function logImportant(msg) {
            logRaw(msg, "important");
            if(isHost) hostConnections.forEach(c => c.open && c.send({type: "LOG", message: msg, style: "important"}));
        }
        
        function logRaw(msg, style) {
            const logDiv = document.getElementById("gameLog");
            const entry = document.createElement("div");
            entry.className = `log-entry ${style}`;
            // åŠ ä¸Šæ™‚é–“
            const time = new Date().toLocaleTimeString('zh-TW', {hour12: false, hour:'2-digit', minute:'2-digit', second:'2-digit'});
            entry.innerHTML = `<span style="font-size:0.8rem; opacity:0.7">[${time}]</span> ${msg}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function playDiceGame() {
            const d1 = Math.floor(Math.random() * 6) + 1;
            const d2 = Math.floor(Math.random() * 6) + 1;
            document.getElementById("dice1").textContent = d1;
            document.getElementById("dice2").textContent = d2;
            const sum = d1 + d2;
            let resultText = "";
            if(d1 === d2) resultText = "è±¹å­ï¼é‹æ°£ä¸éŒ¯å–”ï¼";
            else if(sum > 9) resultText = "å¤§é»æ•¸ï¼";
            else resultText = "é»æ•¸ä¸€èˆ¬èˆ¬...";
            document.getElementById("diceResult").textContent = `ç¸½å’Œ: ${sum} - ${resultText}`;
            
            // å¦‚æœåœ¨æˆ¿é–“å…§ï¼Œå¯ä»¥ç™¼é€é€™å€‹å°äº’å‹• (é¸åš)
        }
    </script>
</body>
</html>
